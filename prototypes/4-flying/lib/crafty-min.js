// From nightly build of 0.6.3: May 11, 2015
!function t(e,i,n){function r(o,a){if(!i[o]){if(!e[o]){var h="function"==typeof require&&require;if(!a&&h)return h(o,!0);if(s)return s(o,!0);throw new Error("Cannot find module '"+o+"'")}var c=i[o]={exports:{}};e[o][0].call(c.exports,function(t){var i=e[o][1][t];return r(i?i:t)},c,c.exports,t,e,i,n)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(){},{}],2:[function(t){var e=t("../core/core.js");e.c("Draggable",{_origX:null,_origY:null,_oldX:null,_oldY:null,_dir:null,init:function(){this.requires("MouseDrag"),this.bind("StartDrag",this._startDrag).bind("Dragging",this._drag)},remove:function(){this.unbind("StartDrag",this._startDrag).unbind("Dragging",this._drag)},enableDrag:function(){return this.uniqueBind("Dragging",this._drag),this},disableDrag:function(){return this.unbind("Dragging",this._drag),this},dragDirection:function(t){if("undefined"==typeof t)this._dir=null;else if(""+parseInt(t,10)==t)this._dir={x:Math.cos(t/180*Math.PI),y:Math.sin(t/180*Math.PI)};else if(0===t.x&&0===t.y)this._dir={x:0,y:0};else{var e=Math.sqrt(t.x*t.x+t.y*t.y);this._dir={x:t.x/e,y:t.y/e}}return this},_startDrag:function(t){this._origX=t.realX,this._origY=t.realY,this._oldX=this._x,this._oldY=this._y},_drag:function(t){if(this._dir){if(0!==this._dir.x||0!==this._dir.y){var e=(t.realX-this._origX)*this._dir.x+(t.realY-this._origY)*this._dir.y;this.x=this._oldX+e*this._dir.x,this.y=this._oldY+e*this._dir.y}}else this.x=this._oldX+(t.realX-this._origX),this.y=this._oldY+(t.realY-this._origY)}}),e.c("Multiway",{_speed:null,init:function(){this.requires("Keyboard, Motion"),this._keyDirection={},this._activeDirections={},this._directionSpeed={},this._speed={x:3,y:3},this.bind("KeyDown",this._keydown).bind("KeyUp",this._keyup)},remove:function(){this.unbind("KeyDown",this._keydown).unbind("KeyUp",this._keyup),this.__unapplyActiveDirections()},_keydown:function(t){var e=this._keyDirection[t.key];void 0!==e&&(0!==this._activeDirections[e]||this.disableControls||(this.vx+=this._directionSpeed[e].x,this.vy+=this._directionSpeed[e].y),this._activeDirections[e]++)},_keyup:function(t){var e=this._keyDirection[t.key];void 0!==e&&(this._activeDirections[e]--,0!==this._activeDirections[e]||this.disableControls||(this.vx-=this._directionSpeed[e].x,this.vy-=this._directionSpeed[e].y))},multiway:function(t,e){return e?void 0!==t.x&&void 0!==t.y?(this._speed.x=t.x,this._speed.y=t.y):(this._speed.x=t,this._speed.y=t):e=t,this.disableControls||this.__unapplyActiveDirections(),this._updateKeys(e),this._updateSpeed(this._speed),this.disableControls||this.__applyActiveDirections(),this},speed:function(t){return this.disableControls||this.__unapplyActiveDirections(),this._updateSpeed(t),this.disableControls||this.__applyActiveDirections(),this},_updateKeys:function(t){this._keyDirection={},this._activeDirections={};for(var i in t){var n=e.keys[i]||i,r=this._keyDirection[n]=t[i];this._activeDirections[r]=this._activeDirections[r]||0,this.isDown(n)&&this._activeDirections[r]++}},_updateSpeed:function(t){this._directionSpeed={};var e;for(var i in this._keyDirection)e=this._keyDirection[i],this._directionSpeed[e]={x:Math.round(1e3*Math.cos(e*(Math.PI/180))*t.x)/1e3,y:Math.round(1e3*Math.sin(e*(Math.PI/180))*t.y)/1e3}},__applyActiveDirections:function(){for(var t in this._activeDirections)this._activeDirections[t]>0&&(this.vx+=this._directionSpeed[t].x,this.vy+=this._directionSpeed[t].y)},__unapplyActiveDirections:function(){for(var t in this._activeDirections)this._activeDirections[t]>0&&(this.vx-=this._directionSpeed[t].x,this.vy-=this._directionSpeed[t].y)},enableControl:function(){return this.disableControls&&this.__applyActiveDirections(),this.disableControls=!1,this},disableControl:function(){return this.disableControls||this.__unapplyActiveDirections(),this.disableControls=!0,this}}),e.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(t){return this.multiway(t||this._speed,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180}),this}}),e.c("Twoway",{_jumpSpeed:6,canJump:!0,init:function(){this.requires("Keyboard, Fourway, Motion, Supportable")},remove:function(){this.unbind("KeyDown",this._keydown_twoway)},_keydown_twoway:function(t){if(!this.disableControls&&(t.key===e.keys.UP_ARROW||t.key===e.keys.W||t.key===e.keys.Z)){var i=this.ground;this.canJump=!!i,this.trigger("CheckJumping",i),this.canJump&&(this.vy=-this._jumpSpeed)}},twoway:function(t,e){return this.multiway(t||this._speed,{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180}),this._jumpSpeed=arguments.length<2?2*this._speed.y:e,this.uniqueBind("KeyDown",this._keydown_twoway),this}})},{"../core/core.js":7}],3:[function(t){var e=t("../core/core.js");e.extend({device:{_deviceOrientationCallback:!1,_deviceMotionCallback:!1,_normalizeDeviceOrientation:function(t){var i;window.DeviceOrientationEvent?i={tiltLR:t.gamma,tiltFB:t.beta,dir:t.alpha,motUD:null}:window.OrientationEvent&&(i={tiltLR:90*t.x,tiltFB:-90*t.y,dir:null,motUD:t.z}),e.device._deviceOrientationCallback(i)},_normalizeDeviceMotion:function(t){var i=t.accelerationIncludingGravity,n=i.z>0?1:-1,r={acceleration:i,rawAcceleration:"["+Math.round(i.x)+", "+Math.round(i.y)+", "+Math.round(i.z)+"]",facingUp:n,tiltLR:Math.round(i.x/9.81*-90),tiltFB:Math.round((i.y+9.81)/9.81*90*n)};e.device._deviceMotionCallback(r)},deviceOrientation:function(t){this._deviceOrientationCallback=t,e.support.deviceorientation&&(window.DeviceOrientationEvent?e.addEvent(this,window,"deviceorientation",this._normalizeDeviceOrientation):window.OrientationEvent&&e.addEvent(this,window,"MozOrientation",this._normalizeDeviceOrientation))},deviceMotion:function(t){this._deviceMotionCallback=t,e.support.devicemotion&&window.DeviceMotionEvent&&e.addEvent(this,window,"devicemotion",this._normalizeDeviceMotion)}}})},{"../core/core.js":7}],4:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({over:null,mouseObjs:0,mousePos:{},lastEvent:null,touchObjs:0,keydown:{},selected:!1,detectBlur:function(t){var i=t.clientX>e.stage.x&&t.clientX<e.stage.x+e.viewport.width&&t.clientY>e.stage.y&&t.clientY<e.stage.y+e.viewport.height;!e.selected&&i&&e.trigger("CraftyFocus"),e.selected&&!i&&e.trigger("CraftyBlur"),e.selected=i},multitouch:function(t){return"boolean"!=typeof t?this._touchHandler.multitouch:void(this._touchHandler.multitouch=t)},resetKeyDown:function(){for(var t in e.keys)e.keydown[e.keys[t]]&&this.trigger("KeyUp",{key:e.keys[t]});e.keydown={}},mouseDispatch:function(t){if(e.mouseObjs){e.lastEvent=t;var i,n,r,s=t.target?t.target:t.srcElement,o=e.domHelper.translate(t.clientX,t.clientY),a=t.type;t.mouseButton="undefined"==typeof t.which?t.button<2?e.mouseButtons.LEFT:4==t.button?e.mouseButtons.MIDDLE:e.mouseButtons.RIGHT:t.which<2?e.mouseButtons.LEFT:2==t.which?e.mouseButtons.MIDDLE:e.mouseButtons.RIGHT,t.realX=n=e.mousePos.x=o.x,t.realY=r=e.mousePos.y=o.y,i=e.findClosestEntityByComponent("Mouse",n,r,s),i?"mousedown"===a?i.trigger("MouseDown",t):"mouseup"===a?i.trigger("MouseUp",t):"dblclick"==a?i.trigger("DoubleClick",t):"click"==a?i.trigger("Click",t):"mousemove"===a?(i.trigger("MouseMove",t),this.over!==i&&(this.over&&(this.over.trigger("MouseOut",t),this.over=null),this.over=i,i.trigger("MouseOver",t))):i.trigger(a,t):("mousemove"===a&&this.over&&(this.over.trigger("MouseOut",t),this.over=null),"mousedown"===a?e.viewport.mouselook("start",t):"mousemove"===a?e.viewport.mouselook("drag",t):"mouseup"==a&&e.viewport.mouselook("stop")),"mousemove"===a&&(this.lastEvent=t)}},touchDispatch:function(t){if(e.touchObjs||e.mouseObjs){if(this._touchHandler.multitouch)switch(t.type){case"touchstart":this._touchHandler.handleStart(t);break;case"touchmove":this._touchHandler.handleMove(t);break;case"touchleave":case"touchcancel":case"touchend":this._touchHandler.handleEnd(t)}else this._touchHandler.mimicMouse(t);t.target&&"INPUT"!==t.target.nodeName&&"TEXTAREA"!==t.target.nodeName&&(t.preventDefault?t.preventDefault():t.returnValue=!1)}},_touchHandler:{fingers:[],multitouch:!1,handleStart:function(t){for(var i=t.changedTouches,n=0,r=i.length;r>n;n++){var s,o,a,h=!1,c=e.domHelper.translate(i[n].clientX,i[n].clientY),u=t.target?t.target:t.srcElement;i[n].realX=s=c.x,i[n].realY=o=c.y,a=this.findClosestTouchEntity(s,o,u),a&&(a.trigger("TouchStart",i[n]),h=this.fingerDownIndexByEntity(a));var l=this.setTouch(i[n],a);h!==!1&&h>=0?this.fingers[h]=l:this.fingers.push(l)}},handleMove:function(t){for(var i=t.changedTouches,n=0,r=i.length;r>n;n++){var s,o,a,h=this.fingerDownIndexById(i[n].identifier),c=e.domHelper.translate(i[n].clientX,i[n].clientY),u=t.target?t.target:t.srcElement;i[n].realX=s=c.x,i[n].realY=o=c.y,a=this.findClosestTouchEntity(s,o,u),h>=0&&("undefined"!=typeof this.fingers[h].entity&&(this.fingers[h].entity==a?this.fingers[h].entity.trigger("TouchMove",i[n]):("object"==typeof a&&a.trigger("TouchStart",i[n]),this.fingers[h].entity.trigger("TouchEnd"))),this.fingers[h].entity=a,this.fingers[h].realX=s,this.fingers[h].realY=o)}},handleEnd:function(t){for(var e=t.changedTouches,i="touchcancel"==t.type?"TouchCancel":"TouchEnd",n=0,r=e.length;r>n;n++){var s=this.fingerDownIndexById(e[n].identifier);s>=0&&(this.fingers[s].entity&&this.fingers[s].entity.trigger(i),this.fingers.splice(s,1))}},setTouch:function(t,e){return{identifier:t.identifier,realX:t.realX,realY:t.realY,entity:e}},findClosestTouchEntity:function(t,i,n){return e.findClosestEntityByComponent("Touch",t,i,n)},fingerDownIndexById:function(t){for(var e=0,i=this.fingers.length;i>e;e++){var n=this.fingers[e].identifier;if(n==t)return e}return-1},fingerDownIndexByEntity:function(t){for(var e=0,i=this.fingers.length;i>e;e++){var n=this.fingers[e].entity;if(n==t)return e}return-1},mimicMouse:function(t){var n,r=e.lastEvent;"touchstart"===t.type?n="mousedown":"touchmove"===t.type?n="mousemove":"touchend"===t.type?n="mouseup":"touchcancel"===t.type?n="mouseup":"touchleave"===t.type&&(n="mouseup"),t.touches&&t.touches.length?first=t.touches[0]:t.changedTouches&&t.changedTouches.length&&(first=t.changedTouches[0]);var s=i.createEvent("MouseEvent");s.initMouseEvent(n,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,t.relatedTarget),first.target.dispatchEvent(s),null!==r&&"mousedown"==r.type&&"mouseup"==n&&(n="click",s=i.createEvent("MouseEvent"),s.initMouseEvent(n,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,t.relatedTarget),first.target.dispatchEvent(s))}},findClosestEntityByComponent:function(t,i,n,r){var s,o,a,h=r?r:e.stage.elem,c=0,u=-1,l={};if("CANVAS"!=h.nodeName){for(;"string"!=typeof h.id&&-1==h.id.indexOf("ent");)h=h.parentNode;var d=e(parseInt(h.id.replace("ent",""),10));d.__c[t]&&d.isAt(i,n)&&(s=d)}if(!s)for(o=e.map.search({_x:i,_y:n,_w:1,_h:1},!1),a=o.length;a>c;++c)if(o[c].__c[t]&&o[c]._visible){var _=o[c],f=!1;if(!l[_[0]]&&(l[_[0]]=!0,_.mapArea?_.mapArea.containsPoint(i,n)&&(f=!0):_.isAt(i,n)&&(f=!0),f&&(_._z>=u||-1===u))){if(_._z===u&&_[0]<s[0])continue;u=_._z,s=_}}return s},keyboardDispatch:function(t){for(var i=t,n={},r="char charCode keyCode type shiftKey ctrlKey metaKey timestamp".split(" "),s=r.length;s;){var o=r[--s];n[o]=i[o]}return n.which=null!==i.charCode?i.charCode:i.keyCode,n.key=i.keyCode||i.which,n.originalEvent=i,t=n,"keydown"===t.type?e.keydown[t.key]!==!0&&(e.keydown[t.key]=!0,e.trigger("KeyDown",t)):"keyup"===t.type&&(delete e.keydown[t.key],e.trigger("KeyUp",t)),e.selected&&!(8==t.key||t.key>=112&&t.key<=135)?(i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,i.target&&"INPUT"!==i.target.nodeName&&"TEXTAREA"!==i.target.nodeName&&(i.preventDefault?i.preventDefault():i.returnValue=!1),!1):void 0}}),e.bind("Load",function(){e.addEvent(this,"keydown",e.keyboardDispatch),e.addEvent(this,"keyup",e.keyboardDispatch),e.addEvent(this,e.stage.elem,"mousedown",e.mouseDispatch),e.addEvent(this,e.stage.elem,"mouseup",e.mouseDispatch),e.addEvent(this,i.body,"mouseup",e.detectBlur),e.addEvent(this,window,"blur",e.resetKeyDown),e.addEvent(this,e.stage.elem,"mousemove",e.mouseDispatch),e.addEvent(this,e.stage.elem,"click",e.mouseDispatch),e.addEvent(this,e.stage.elem,"dblclick",e.mouseDispatch),e.addEvent(this,e.stage.elem,"touchstart",e.touchDispatch),e.addEvent(this,e.stage.elem,"touchmove",e.touchDispatch),e.addEvent(this,e.stage.elem,"touchend",e.touchDispatch),e.addEvent(this,e.stage.elem,"touchcancel",e.touchDispatch),e.addEvent(this,e.stage.elem,"touchleave",e.touchDispatch)}),e.bind("CraftyStop",function(){e.removeEvent(this,"keydown",e.keyboardDispatch),e.removeEvent(this,"keyup",e.keyboardDispatch),e.stage&&(e.removeEvent(this,e.stage.elem,"mousedown",e.mouseDispatch),e.removeEvent(this,e.stage.elem,"mouseup",e.mouseDispatch),e.removeEvent(this,e.stage.elem,"mousemove",e.mouseDispatch),e.removeEvent(this,e.stage.elem,"click",e.mouseDispatch),e.removeEvent(this,e.stage.elem,"dblclick",e.mouseDispatch),e.removeEvent(this,e.stage.elem,"touchstart",e.touchDispatch),e.removeEvent(this,e.stage.elem,"touchmove",e.touchDispatch),e.removeEvent(this,e.stage.elem,"touchend",e.touchDispatch),e.removeEvent(this,e.stage.elem,"touchcancel",e.touchDispatch),e.removeEvent(this,e.stage.elem,"touchleave",e.touchDispatch)),e.removeEvent(this,i.body,"mouseup",e.detectBlur),e.removeEvent(this,window,"blur",e.resetKeyDown)}),e.c("Mouse",{init:function(){e.mouseObjs++,this.requires("AreaMap").bind("Remove",function(){e.mouseObjs--})}}),e.c("Touch",{init:function(){e.touchObjs++,this.requires("AreaMap").bind("Remove",function(){e.touchObjs--})}}),e.c("AreaMap",{init:function(){},areaMap:function(t){if(arguments.length>1){var i=Array.prototype.slice.call(arguments,0);t=new e.polygon(i)}return t.shift(this._x,this._y),this.mapArea=t,this.attach(this.mapArea),this}}),e.c("Button",{init:function(){var t=!e.mobile||e.mobile&&!e.multitouch()?"Mouse":"Touch";this.requires(t)}}),e.c("MouseDrag",{_dragging:!1,init:function(){this.requires("Mouse"),this.bind("MouseDown",this._ondown)},remove:function(){this.unbind("MouseDown",this._ondown)},_ondown:function(t){t.mouseButton===e.mouseButtons.LEFT&&this.startDrag(t)},_ondrag:function(t){return this._dragging&&0!==t.realX&&0!==t.realY?void this.trigger("Dragging",t):!1},_onup:function(t){t.mouseButton===e.mouseButtons.LEFT&&this.stopDrag(t)},startDrag:function(t){return this._dragging?void 0:(this._dragging=!0,e.addEvent(this,e.stage.elem,"mousemove",this._ondrag),e.addEvent(this,e.stage.elem,"mouseup",this._onup),this.trigger("StartDrag",t||e.lastEvent),this)},stopDrag:function(t){return this._dragging?(this._dragging=!1,e.removeEvent(this,e.stage.elem,"mousemove",this._ondrag),e.removeEvent(this,e.stage.elem,"mouseup",this._onup),this.trigger("StopDrag",t||e.lastEvent),this):void 0}}),e.c("Keyboard",{isDown:function(t){return"string"==typeof t&&(t=e.keys[t]),!!e.keydown[t]}})},{"../core/core.js":7}],5:[function(t){var e=t("../core/core.js");e.extend({keys:{BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,PULT_UP:29460,PULT_DOWN:29461,PULT_LEFT:4,PULT_RIGHT:5},mouseButtons:{LEFT:0,MIDDLE:1,RIGHT:2}})},{"../core/core.js":7}],6:[function(t){var e=t("../core/core.js");e.easing=function(t,i){this.timePerFrame=1e3/e.timer.FPS(),this.duration=t,this.easing_function="function"==typeof i?i:"string"==typeof i&&this.standardEasingFunctions[i]?this.standardEasingFunctions[i]:this.standardEasingFunctions.linear,this.reset()},e.easing.prototype={duration:0,clock:0,steps:null,complete:!1,paused:!1,reset:function(){this.loops=1,this.clock=0,this.complete=!1,this.paused=!1},repeat:function(t){this.loops=t},setProgress:function(t,e){this.clock=this.duration*t,"undefined"!=typeof e&&(this.loops=e)},pause:function(){this.paused=!0},resume:function(){this.paused=!1,this.complete=!1},tick:function(t){if(!this.paused&&!this.complete)for(this.clock+=t,this.frames=Math.floor(this.clock/this.timePerFrame);this.clock>=this.duration&&this.complete===!1;)this.loops--,this.loops>0?this.clock-=this.duration:this.complete=!0},time:function(){return Math.min(this.clock/this.duration,1)},value:function(){return this.easing_function(this.time())},standardEasingFunctions:{linear:function(t){return t},smoothStep:function(t){return(3-2*t)*t*t},smootherStep:function(t){return(6*t*t-15*t+10)*t*t*t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return.5>t?2*t*t:(4-2*t)*t-1}}},e.c("Tween",{init:function(){this.tweenGroup={},this.tweenStart={},this.tweens=[],this.bind("EnterFrame",this._tweenTick)},_tweenTick:function(t){var e,i,n;for(n=this.tweens.length-1;n>=0;n--)e=this.tweens[n],e.easing.tick(t.dt),i=e.easing.value(),this._doTween(e.props,i),e.easing.complete&&(this.tweens.splice(n,1),this._endTween(e.props))},_doTween:function(t,e){for(var i in t)this[i]=(1-e)*this.tweenStart[i]+e*t[i]},tween:function(t,i,n){var r={props:t,easing:new e.easing(i,n)};for(var s in t)"undefined"!=typeof this.tweenGroup[s]&&this.cancelTween(s),this.tweenStart[s]=this[s],this.tweenGroup[s]=t;return this.tweens.push(r),this},cancelTween:function(t){if("string"==typeof t)"object"==typeof this.tweenGroup[t]&&delete this.tweenGroup[t][t];else if("object"==typeof t)for(var e in t)this.cancelTween(e);return this},_endTween:function(t){for(var e in t)delete this.tweenGroup[e];this.trigger("TweenEnd",t)}})},{"../core/core.js":7}],7:[function(t,e){function n(){var t=s++;return t in h?n():t}function r(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var i in t)e[i]=r(t[i]);return e}var s,o,a,h,c,u,l,d,_,f=t("./version"),p=function(t){return new p.fn.init(t)};a={},l=Array.prototype.slice,d=/\s*,\s*/,_=/\s+/;var g=function(){s=1,o=0,h={},c={},u=[]};g(),p.fn=p.prototype={init:function(t){if("string"!=typeof t)return t||(t=0,t in h||(h[t]=this)),t in h?(this[0]=t,this.length=1,this.__c||(this.__c={}),this._callbacks||p._addCallbackMethods(this),h[t]||(h[t]=this),h[t]):(this.length=0,this);var e,i,n,r,s,o,c,u=0,l=!1,f=!1;if("*"===t){o=0;for(e in h)this[o]=+e,o++;return this.length=o,1===o?h[this[0]]:this}-1!==t.indexOf(",")?(f=!0,n=d):-1!==t.indexOf(" ")&&(l=!0,n=_);for(e in h)if(h.hasOwnProperty(e))if(i=h[e],l||f){for(r=t.split(n),o=0,c=r.length,s=0;c>o;o++)i.__c[r[o]]&&s++;(l&&s===c||f&&s>0)&&(this[u++]=+e)}else i.__c[t]&&(this[u++]=+e);if(u>0&&!l&&!f&&this.extend(a[t]),r&&l)for(o=0;c>o;o++)this.extend(a[r[o]]);return this.length=u,1===u?h[this[u-1]]:(p._addCallbackMethods(this),this)},setName:function(t){var e=String(t);return this._entityName=e,this.trigger("NewEntityName",e),this},addComponent:function(t){var e,i,n=0;for(e=1===arguments.length&&-1!==t.indexOf(",")?t.split(d):arguments;n<e.length;n++)if(this.__c[e[n]]!==!0&&(this.__c[e[n]]=!0,i=a[e[n]],this.extend(i),i&&"required"in i&&this.requires(i.required),i&&"init"in i&&i.init.call(this),i&&"events"in i)){var r=i.events;for(var s in r){var o="function"==typeof r[s]?r[s]:i[r[s]];this.bind(s,o)}}return this.trigger("NewComponent",e),this},toggleComponent:function(t){var e,i,n=0;if(arguments.length>1)for(e=arguments.length;e>n;n++)this.has(arguments[n])?this.removeComponent(arguments[n]):this.addComponent(arguments[n]);else if(-1!==t.indexOf(","))for(i=t.split(d),e=i.length;e>n;n++)this.has(i[n])?this.removeComponent(i[n]):this.addComponent(i[n]);else this.has(t)?this.removeComponent(t):this.addComponent(t);return this},requires:function(t){return this.addComponent(t)},removeComponent:function(t,e){var i=a[t];if(this.trigger("RemoveComponent",t),i&&"events"in i){var n=i.events;for(var r in n){var s="function"==typeof n[r]?n[r]:i[n[r]];this.unbind(r,s)}}if(i&&"remove"in i&&i.remove.call(this,!1),e===!1&&i)for(var o in i)delete this[o];return delete this.__c[t],this},getId:function(){return this[0]},has:function(t){return!!this.__c[t]},attr:function(t,e,i,n){return 1===arguments.length&&"string"==typeof arguments[0]?this._attr_get(t):this._attr_set(t,e,i,n)},_attr_get:function(t,e){var i,n,r;return("undefined"==typeof e||null===e)&&(e=this),t.indexOf(".")>-1?(n=t.split("."),i=n.shift(),r=n.join("."),this._attr_get(n.join("."),e[i])):e[t]},_attr_set:function(){var t,e,i;return"string"==typeof arguments[0]?(t=this._set_create_object(arguments[0],arguments[1]),e=!!arguments[2],i=arguments[3]||arguments[0].indexOf(".")>-1):(t=arguments[0],e=!!arguments[1],i=!!arguments[2]),e||this.trigger("Change",t),i?this._recursive_extend(t,this):this.extend.call(this,t),this},_set_create_object:function(t,e){var i,n,r,s={};return t.indexOf(".")>-1?(i=t.split("."),n=i.shift(),r=i.join("."),s[n]=this._set_create_object(r,e)):s[t]=e,s},_recursive_extend:function(t,e){var i;for(i in t)e[i]="Object"===t[i].constructor.name?this._recursive_extend(t[i],e[i]):t[i];return e},toArray:function(){return l.call(this,0)},timeout:function(t,e){return this.each(function(){var i=this;setTimeout(function(){t.call(i)},e)}),this},bind:function(t,e){if(1===this.length)this._bindCallback(t,e);else for(var i=0;i<this.length;i++){var n=h[this[i]];n&&n._bindCallback(t,e)}return this},uniqueBind:function(t,e){this.unbind(t,e),this.bind(t,e)},one:function(t,e){var i=this,n=function(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},unbind:function(t,e){var i,n;for(i=0;i<this.length;i++)n=h[this[i]],n&&n._unbindCallbacks(t,e);return this},trigger:function(t,e){if(1===this.length)this._runCallbacks(t,e);else for(var i=0;i<this.length;i++){var n=h[this[i]];n&&n._runCallbacks(t,e)}return this},each:function(t){for(var e=0,i=this.length;i>e;e++)h[this[e]]&&t.call(h[this[e]],e);return this},get:function(t){var e=this.length;if("undefined"!=typeof t)return t>=e||0>t+e?void 0:t>=0?h[this[t]]:h[this[t+e]];for(var i=0,n=[];e>i;i++)h[this[i]]&&n.push(h[this[i]]);return n},clone:function(){var t,e,i=this.__c,n=p.e();for(t in i)n.addComponent(t);for(e in this)"0"!=e&&"_global"!=e&&"_changed"!=e&&"function"!=typeof this[e]&&"object"!=typeof this[e]&&(n[e]=this[e]);return n},setter:function(t,e){return this.defineField(t,function(){},e)},defineField:function(t,e,i){return p.defineField(this,t,e,i),this},destroy:function(){this.each(function(){var t;this.trigger("Remove");for(var e in this.__c)t=a[e],t&&"remove"in t&&t.remove.call(this,!0);this._unbindAll(),delete h[this[0]]})}},p.fn.init.prototype=p.fn,p.extend=p.fn.extend=function(t){var e,i=this;if(!t)return i;for(e in t)i!==t[e]&&(i[e]=t[e]);return i},p._callbackMethods={_bindCallback:function(t,e){var i=this._callbacks[t];i||(i=this._callbacks[t]=(c[t]||(c[t]={}))[this[0]]=[],i.context=this,i.depth=0),i.push(e)},_runCallbacks:function(t,e){if(this._callbacks[t]){var i,n=this._callbacks[t],r=n.length;for(n.depth++,i=0;r>i;i++)"undefined"==typeof n[i]?n.depth<=1&&(n.splice(i,1),i--,r--):n[i].call(this,e);n.depth--}},_unbindCallbacks:function(t,e){if(this._callbacks[t]){var n=this._callbacks[t];for(i=0;i<n.length;i++)e&&n[i]!=e||delete n[i]}},_unbindAll:function(){if(this._callbacks)for(var t in this._callbacks)this._callbacks[t]&&(this._unbindCallbacks(t),delete c[t][this[0]])}},p._addCallbackMethods=function(t){t.extend(p._callbackMethods),t._callbacks={}},p._addCallbackMethods(p),p.extend({0:"global",init:function(t,e,i){return p.viewport.init(t,e,i),this.trigger("Load"),this.timer.init(),this},getVersion:function(){return f},stop:function(t){if(this.timer.stop(),t){if(p.audio.remove(),p.stage&&p.stage.elem.parentNode){var e=document.createElement("div");e.id=p.stage.elem.id,p.stage.elem.parentNode.replaceChild(e,p.stage.elem)}g()}return p.trigger("CraftyStop"),this},pause:function(t){return(1===arguments.length?t:!this._paused)?(this.trigger("Pause"),this._paused=!0,setTimeout(function(){p.timer.stop()},0),p.keydown={}):(this.trigger("Unpause"),this._paused=!1,setTimeout(function(){p.timer.init()},0)),this},isPaused:function(){return this._paused},timer:function(){var t,e,i,n="fixed",r=5,s=40,a=0,h=0,c=50,u=1e3/c;return{init:function(){"undefined"==typeof i&&(i=(new Date).getTime()-u);var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;n?(t=function(){p.timer.step(),null!==t&&(e=n(t))})():t=setInterval(function(){p.timer.step()},1e3/c)},stop:function(){p.trigger("CraftyStopTimer"),"function"!=typeof t&&clearInterval(t);var i=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||null;i&&i(e),t=null},steptype:function(t,e){if("variable"===t||"semifixed"===t)n=t,e&&(s=e);else{if("fixed"!==t)throw"Invalid step type specified";n="fixed",e&&(r=e)}},step:function(){var t,e,c,l=0;if(currentTime=(new Date).getTime(),a>0&&p.trigger("MeasureWaitTime",currentTime-a),i+h>=currentTime)return void(a=currentTime);var d=currentTime-(i+h);d>20*u&&(h+=d-u,d=u),"fixed"===n?(l=Math.ceil(d/u),l=Math.min(l,r),e=u):"variable"===n?(l=1,e=d,e=Math.min(e,s)):"semifixed"===n&&(l=Math.ceil(d/s),e=d/l);for(var _=0;l>_;_++){c=currentTime;var f={frame:o++,dt:e,gameTime:i};p.trigger("EnterFrame",f),p.trigger("ExitFrame",f),i+=e,currentTime=(new Date).getTime(),p.trigger("MeasureFrameTime",currentTime-c)}l>0&&(t=currentTime,p.trigger("PreRender"),p.trigger("RenderScene"),p.trigger("PostRender"),currentTime=(new Date).getTime(),p.trigger("MeasureRenderTime",currentTime-t)),a=currentTime},FPS:function(t){return"undefined"==typeof t?c:(c=t,u=1e3/c,p.trigger("FPSChange",t),void 0)},simulateFrames:function(t,e){for("undefined"==typeof e&&(e=u);t-->0;){var i={frame:o++,dt:e};p.trigger("EnterFrame",i),p.trigger("ExitFrame",i)}p.trigger("PreRender"),p.trigger("RenderScene"),p.trigger("PostRender")}}}(),e:function(){var t=n();return h[t]=null,h[t]=p(t),arguments.length>0&&h[t].addComponent.apply(h[t],arguments),h[t].setName("Entity #"+t),h[t].addComponent("obj"),p.trigger("NewEntity",{id:t}),h[t]},c:function(t,e){a[t]=e},trigger:function(t,e){var i,n,r=c[t]||(c[t]={});for(i in r)r.hasOwnProperty(i)&&(n=r[i],n&&0!==n.length&&n.context._runCallbacks(t,e))},bind:function(t,e){return this._bindCallback(t,e),e},uniqueBind:function(t,e){return this.unbind(t,e),this.bind(t,e)},one:function(t,e){var i=this,n=function(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},unbind:function(t,e){this._unbindCallbacks(t,e)},frame:function(){return o},components:function(){return a},isComp:function(t){return t in a},debug:function(t){return"handlers"===t?c:h},settings:function(){var t={},e={};return{register:function(t,i){e[t]=i},modify:function(i,n){e[i]&&(e[i].call(t[i],n),t[i]=n)},get:function(e){return t[e]}}}(),defineField:function(t,e,i,n){Object.defineProperty(t,e,{get:i,set:n,configurable:!1,enumerable:!0})},clone:r}),"function"==typeof define&&define("crafty",[],function(){return p}),e.exports=p},{"./version":15}],8:[function(t){var e=t("../core/core.js"),i=window.document;!function(){var t=e.support={},n=navigator.userAgent.toLowerCase(),r=/(webkit)[ \/]([\w.]+)/.exec(n)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(n)||/(ms)ie ([\w.]+)/.exec(n)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(n)||[],s=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(n);if(s&&(e.mobile=s[0]),t.defineProperty=function(){if(!("defineProperty"in Object))return!1;try{Object.defineProperty({},"x",{})}catch(t){return!1}return!0}(),t.audio="canPlayType"in i.createElement("audio"),t.prefix=r[1]||r[0],"moz"===t.prefix&&(t.prefix="Moz"),"o"===t.prefix&&(t.prefix="O"),r[2]&&(t.versionName=r[2],t.version=+r[2].split(".")[0]),t.canvas="getContext"in i.createElement("canvas"),t.canvas){var o;try{var a=i.createElement("canvas");o=a.getContext("webgl")||a.getContext("experimental-webgl"),o.viewportWidth=t.canvas.width,o.viewportHeight=t.canvas.height}catch(h){}t.webgl=!!o}else t.webgl=!1;t.css3dtransform="undefined"!=typeof i.createElement("div").style.Perspective||"undefined"!=typeof i.createElement("div").style[t.prefix+"Perspective"],t.deviceorientation="undefined"!=typeof window.DeviceOrientationEvent||"undefined"!=typeof window.OrientationEvent,t.devicemotion="undefined"!=typeof window.DeviceMotionEvent}(),e.extend({_events:{},addEvent:function(t,e,i,n){3===arguments.length&&(n=i,i=e,e=window.document);var r=function(e){e=e||window.event,"function"==typeof n&&n.call(t,e)},s=t[0]||"";this._events[s+e+i+n]||(this._events[s+e+i+n]=r,e.attachEvent?e.attachEvent("on"+i,r):e.addEventListener(i,r,!1))},removeEvent:function(t,e,i,n){3===arguments.length&&(n=i,i=e,e=window.document);var r=t[0]||"",s=this._events[r+e+i+n];s&&(e.detachEvent?e.detachEvent("on"+i,s):e.removeEventListener(i,s,!1),delete this._events[r+e+i+n])},background:function(t){e.stage.elem.style.background=t}})},{"../core/core.js":7}],9:[function(t){var e=t("../core/core.js");e.extend({assets:{},__paths:{audio:"",images:""},paths:function(t){return"undefined"==typeof t?this.__paths:(t.audio&&(this.__paths.audio=t.audio),void(t.images&&(this.__paths.images=t.images)))},asset:function(t,i){return 1===arguments.length?e.assets[t]:e.assets[t]?void 0:(e.assets[t]=i,this.trigger("NewAsset",{key:t,value:i}),i)},image_whitelist:["jpg","jpeg","gif","png","svg"],load:function(t,i,n,r){function s(){var t=this.src;this.removeEventListener&&this.removeEventListener("canplaythrough",s,!1),d++,n&&n({loaded:d,total:_,percent:d/_*100,src:t}),d===_&&i&&i()}function o(){var t=this.src;r&&r({loaded:d,total:_,percent:d/_*100,src:t}),d++,d===_&&i&&i()}t="string"==typeof t?JSON.parse(t):t;var a,h,c,u,l,d=0,_=(t.audio?Object.keys(t.audio).length:0)+(t.images?Object.keys(t.images).length:0)+(t.sprites?Object.keys(t.sprites).length:0),f=e.support.audio,p=e.paths(),g=function(t){return t.substr(t.lastIndexOf(".")+1,3).toLowerCase()},m=function(t,e){return-1===e.search("://")?"audio"==t?p.audio+e:p.images+e:e},v=function(t){return e.asset(t)||null},y=function(t){return e.audio.supports(g(t))},x=function(t){return-1!=e.image_whitelist.indexOf(g(t))},w=function(t,i){t.onload=s,"webkit"===e.support.prefix&&(t.src=""),t.src=i};for(u in t)for(l in t[u]){if(a=t[u][l],"audio"===u&&f){if("object"==typeof a){var b=[];for(var D in a)h=m(u,a[D]),!v(h)&&y(a[D])&&b.push(h);c=e.audio.add(l,b).obj}else"string"==typeof a&&y(a)&&(h=m(u,a),v(h)||(c=e.audio.add(l,h).obj));c&&c.addEventListener&&c.addEventListener("canplaythrough",s,!1)}else l="sprites"===u?l:a,h=m(u,l),x(l)&&(c=v(h),c||(c=new Image,"sprites"===u&&e.sprite(a.tile,a.tileh,h,a.map,a.paddingX,a.paddingY,a.paddingAroundBorder),e.asset(h,c)),w(c,h));c?c.onerror=o:--_}0===_&&i()},removeAssets:function(t){t="string"==typeof t?JSON.parse(t):t;var i,n,r,s,o=e.paths(),a=function(t,e){return-1===e.search("://")?"audio"==t?o.audio+e:o.images+e:e};for(r in t)for(s in t[r])if(i=t[r][s],"audio"===r)if("object"==typeof i)for(var h in i)n=a(r,i[h]),e.asset(n)&&e.audio.remove(s);else"string"==typeof i&&(n=a(r,i),e.asset(n)&&e.audio.remove(s));else if(s="sprites"===r?s:i,n=a(r,s),e.asset(n)){if("sprites"===r)for(var c in i.map)delete e.components()[c];delete e.assets[n]}}})},{"../core/core.js":7}],10:[function(t){var e=t("../core/core.js");e.c("Model",{init:function(){this.changed=[],this.bind("Change",this._changed_attributes),this.bind("Change",this._changed_triggers)},_changed_triggers:function(t,i){var n;i=e.extend.call({pre:""},i);for(n in t)this.trigger("Change["+i.pre+n+"]",t[n]),"Object"===t[n].constructor.name&&this._changed_triggers(t[n],{pre:i.pre+n+"."})
},_changed_attributes:function(t){var e;for(e in t)this.changed.push(e);return this},is_dirty:function(t){return 0===arguments.length?!!this.changed.length:this.changed.indexOf(t)>-1}})},{"../core/core.js":7}],11:[function(t){var e=t("../core/core.js");e.extend({_scenes:{},_current:null,scene:function(t,i,n){return 1===arguments.length||"function"!=typeof arguments[1]?void e.enterScene(t,arguments[1]):void e.defineScene(t,i,n)},defineScene:function(t,e,i){if("function"!=typeof e)throw"Init function is the wrong type.";this._scenes[t]={},this._scenes[t].initialize=e,"undefined"!=typeof i&&(this._scenes[t].uninitialize=i)},enterScene:function(t,i){if("function"==typeof i)throw"Scene data cannot be a function";e.trigger("SceneDestroy",{newScene:t}),e.viewport.reset(),e("2D").each(function(){this.has("Persist")||this.destroy()}),null!==this._current&&"uninitialize"in this._scenes[this._current]&&this._scenes[this._current].uninitialize.call(this);var n=this._current;this._current=t,e.trigger("SceneChange",{oldScene:n,newScene:t}),this._scenes.hasOwnProperty(t)?this._scenes[t].initialize.call(this,i):console.error('The scene "'+t+'" does not exist')}})},{"../core/core.js":7}],12:[function(t){var e=t("../core/core.js");e.storage=function(t,e){var i=window.localStorage,n=e;if(!i)return!1;if(1===arguments.length)try{return JSON.parse(i.getItem(t))}catch(r){return i.getItem(t)}else"object"==typeof e&&(n=JSON.stringify(e)),i.setItem(t,n)},e.storage.remove=function(t){window.localStorage.removeItem(t)}},{"../core/core.js":7}],13:[function(t){var e=t("../core/core.js");e._systems={},e.s=function(t,i,n){return i?void(n===!1?(e._systems[t]=new e.CraftySystem(t,i),e.trigger("SystemLoaded",t)):e._registerLazySystem(t,i)):e._systems[t]},e._registerLazySystem=function(t,i){Object.defineProperty(e._systems,t,{get:function(){return Object.defineProperty(e._systems,t,{value:new e.CraftySystem(t,i),writable:!0,enumerable:!0,configurable:!0}),e.trigger("SystemLoaded",t),e._systems[t]},configurable:!0})},e.CraftySystem=function(){return systemID=1,function(t,i){if(this.name=t,!i)return this;if(this._systemTemplate=i,this.extend(i),e._addCallbackMethods(this),this[0]="system"+systemID++,"function"==typeof this.init&&this.init(t),"events"in i){var n=i.events;for(var r in n){var s="function"==typeof n[r]?n[r]:i[n[r]];this.bind(r,s)}}}}(),e.CraftySystem.prototype={extend:function(t){for(var e in t)"undefined"==typeof this[e]&&(this[e]=t[e])},bind:function(t,e){return this._bindCallback(t,e),this},trigger:function(t,e){return this._runCallbacks(t,e),this},unbind:function(t,e){return this._unbindCallbacks(t,e),this},one:function(t,e){var i=this,n=function(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},uniqueBind:function(t,e){return this.unbind(t,e),this.bind(t,e)},destroy:function(){e.trigger("SystemDestroyed",this),"function"==typeof this.remove&&this.remove(),this._unbindAll(),delete e._systems[this.name]}}},{"../core/core.js":7}],14:[function(t){var e=t("../core/core.js");e.c("Delay",{init:function(){this._delays=[],this.bind("EnterFrame",function(t){for(var e=this._delays.length;--e>=0;){var i=this._delays[e];if(i===!1)this._delays.splice(e,1);else{for(i.accumulator+=t.dt;i.accumulator>=i.delay&&i.repeat>=0;)i.accumulator-=i.delay,i.repeat--,i.callback.call(this);i.repeat<0&&(this._delays.splice(e,1),"function"==typeof i.callbackOff&&i.callbackOff.call(this))}}})},delay:function(t,e,i,n){return this._delays.push({accumulator:0,callback:t,callbackOff:n,delay:e,repeat:(0>i?1/0:i)||0}),this},cancelDelay:function(t){for(var e=this._delays.length;--e>=0;){var i=this._delays[e];i&&i.callback==t&&(this._delays[e]=!1)}return this}})},{"../core/core.js":7}],15:[function(t,e){e.exports="0.6.2"},{}],16:[function(t,e){var i=t("./core/core");t("./core/animation"),t("./core/extensions"),t("./core/loader"),t("./core/model"),t("./core/scenes"),t("./core/storage"),t("./core/systems"),t("./core/time"),t("./core/version"),t("./spatial/2d"),t("./spatial/collision"),t("./spatial/spatial-grid"),t("./spatial/rect-manager"),t("./spatial/math"),t("./graphics/canvas"),t("./graphics/canvas-layer"),t("./graphics/color"),t("./graphics/dom"),t("./graphics/dom-helper"),t("./graphics/dom-layer"),t("./graphics/drawing"),t("./graphics/gl-textures"),t("./graphics/html"),t("./graphics/image"),t("./graphics/particles"),t("./graphics/sprite-animation"),t("./graphics/sprite"),t("./graphics/text"),t("./graphics/viewport"),t("./graphics/webgl"),t("./isometric/diamond-iso"),t("./isometric/isometric"),t("./controls/inputs"),t("./controls/controls"),t("./controls/device"),t("./controls/keycodes"),t("./sound/sound"),t("./debug/debug-layer"),window&&(window.Crafty=i),e.exports=i},{"./controls/controls":2,"./controls/device":3,"./controls/inputs":4,"./controls/keycodes":5,"./core/animation":6,"./core/core":7,"./core/extensions":8,"./core/loader":9,"./core/model":10,"./core/scenes":11,"./core/storage":12,"./core/systems":13,"./core/time":14,"./core/version":15,"./debug/debug-layer":17,"./graphics/canvas":19,"./graphics/canvas-layer":18,"./graphics/color":20,"./graphics/dom":23,"./graphics/dom-helper":21,"./graphics/dom-layer":22,"./graphics/drawing":24,"./graphics/gl-textures":25,"./graphics/html":26,"./graphics/image":27,"./graphics/particles":28,"./graphics/sprite":30,"./graphics/sprite-animation":29,"./graphics/text":31,"./graphics/viewport":32,"./graphics/webgl":33,"./isometric/diamond-iso":34,"./isometric/isometric":35,"./sound/sound":36,"./spatial/2d":37,"./spatial/collision":38,"./spatial/math":39,"./spatial/rect-manager":40,"./spatial/spatial-grid":41}],17:[function(t){var e=t("../core/core.js"),i=window.document;e.c("DebugCanvas",{init:function(){this.requires("2D"),e.DebugCanvas.context||e.DebugCanvas.init(),e.DebugCanvas.add(this),this._debug={alpha:1,lineWidth:1},this.bind("RemoveComponent",this.onDebugRemove),this.bind("Remove",this.onDebugDestroy)},onDebugRemove:function(t){"DebugCanvas"===t&&e.DebugCanvas.remove(this)},onDebugDestroy:function(){e.DebugCanvas.remove(this)},debugAlpha:function(t){return this._debug.alpha=t,this},debugFill:function(t){return"undefined"==typeof t&&(t="red"),this._debug.fillStyle=t,this},debugStroke:function(t){return"undefined"==typeof t&&(t="red"),this._debug.strokeStyle=t,this},debugDraw:function(t){var e=t.globalAlpha,i=this._debug;i.alpha&&(t.globalAlpha=this._debug.alpha),i.strokeStyle&&(t.strokeStyle=i.strokeStyle),i.lineWidth&&(t.lineWidth=i.lineWidth),i.fillStyle&&(t.fillStyle=i.fillStyle),this.trigger("DebugDraw"),t.globalAlpha=e}}),e.c("DebugRectangle",{init:function(){this.requires("2D, DebugCanvas")},debugRectangle:function(t){return this.debugRect=t,this.unbind("DebugDraw",this.drawDebugRect),this.bind("DebugDraw",this.drawDebugRect),this},drawDebugRect:function(){var t=e.DebugCanvas.context,i=this.debugRect;null!==i&&void 0!==i&&i._h&&i._w&&(this._debug.fillStyle&&t.fillRect(i._x,i._y,i._w,i._h),this._debug.strokeStyle&&t.strokeRect(i._x,i._y,i._w,i._h))}}),e.c("VisibleMBR",{init:function(){this.requires("DebugRectangle").debugFill("purple").bind("EnterFrame",this._assignRect)},_assignRect:function(){this.debugRectangle(this._mbr?this._mbr:this)}}),e.c("DebugPolygon",{init:function(){this.requires("2D, DebugCanvas")},debugPolygon:function(t){return this.polygon=t,this.unbind("DebugDraw",this.drawDebugPolygon),this.bind("DebugDraw",this.drawDebugPolygon),this},drawDebugPolygon:function(){if("undefined"!=typeof this.polygon){var t=e.DebugCanvas.context;t.beginPath();for(var i=this.polygon.points,n=i.length,r=0;n>r;r+=2)t.lineTo(i[r],i[r+1]);t.closePath(),this._debug.fillStyle&&t.fill(),this._debug.strokeStyle&&t.stroke()}}}),e.c("WiredHitBox",{init:function(){this.requires("DebugPolygon").debugStroke("red").matchHitBox(),this.bind("NewHitbox",this.matchHitBox)},matchHitBox:function(){this.debugPolygon(this.map)}}),e.c("SolidHitBox",{init:function(){this.requires("Collision, DebugPolygon").debugFill("orange").debugAlpha(.7).matchHitBox(),this.bind("NewHitbox",this.matchHitBox)},matchHitBox:function(){this.debugPolygon(this.map)}}),e.DebugCanvas={context:null,entities:[],onetimeEntities:[],add:function(t){this.entities.push(t)},remove:function(t){for(var e=this.entities,i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1)},init:function(){if(!e.DebugCanvas.context){if(!e.support.canvas)return e.trigger("NoCanvas"),void e.stop();var t;t=i.createElement("canvas"),t.width=e.viewport.width,t.height=e.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.id="debug-canvas",t.style.zIndex=1e5,e.stage.elem.appendChild(t),e.DebugCanvas.context=t.getContext("2d"),e.DebugCanvas._canvas=t}e.unbind("RenderScene",e.DebugCanvas.renderScene),e.bind("RenderScene",e.DebugCanvas.renderScene)},renderScene:function(t){t=t||e.viewport.rect();var i,n=e.DebugCanvas.entities,r=0,s=n.length,o=e.DebugCanvas.context,a=e.viewport;for(o.setTransform(a._scale,0,0,a._scale,Math.round(a._x*a._scale),Math.round(a._y*a._scale)),o.clearRect(t._x,t._y,t._w,t._h);s>r;r++)i=n[r],i.debugDraw(o)}}},{"../core/core.js":7}],18:[function(t){var e=t("../core/core.js");e.extend({canvasLayer:{_dirtyRects:[],_changedObjs:[],layerCount:0,_dirtyViewport:!1,_sort:function(t,e){return t._globalZ-e._globalZ},add:function(t){this._changedObjs.push(t)},context:null,_canvas:null,init:function(){if(!e.support.canvas)return e.trigger("NoCanvas"),void e.stop();var t;t=document.createElement("canvas"),t.width=e.viewport.width,t.height=e.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px";e.canvasLayer;e.stage.elem.appendChild(t),this.context=t.getContext("2d"),this._canvas=t;var i=e.viewport._scale;1!=i&&t.scale(i,i),this._setPixelart(e._pixelartEnabled),e.uniqueBind("PixelartSet",this._setPixelart),e.uniqueBind("RenderScene",this._render),e.uniqueBind("ViewportResize",this._resize),e.bind("InvalidateViewport",function(){e.canvasLayer._dirtyViewport=!0})},_render:function(){var t=e.canvasLayer,i=t._dirtyViewport,n=t._changedObjs.length,r=t.context;if(n||i){if(i){var s=e.viewport;r.setTransform(s._scale,0,0,s._scale,Math.round(s._x*s._scale),Math.round(s._y*s._scale))}n/t.layerCount>.6||i?t._drawAll():t._drawDirty(),t._clean()}},_drawDirty:function(){var t,i,n,r,s,o,a=this._changedObjs,h=a.length,c=this._dirtyRects,u=e.rectManager,l=u.overlap,d=this.context,_=[],f=[];for(t=0;h>t;t++)this._createDirty(a[t]);for(u.mergeSet(c),h=c.length,t=0;h>t;++t)if(r=c[t],_.length=0,f.length=0,r){for(r._w=r._x+r._w,r._h=r._y+r._h,r._x=r._x>0?0|r._x:(0|r._x)-1,r._y=r._y>0?0|r._y:(0|r._y)-1,r._w-=r._x,r._h-=r._y,r._w=r._w===(0|r._w)?r._w:(0|r._w)+1,r._h=r._h===(0|r._h)?r._h:(0|r._h)+1,n=e.map.search(r,!1),d.clearRect(r._x,r._y,r._w,r._h),d.save(),d.beginPath(),d.rect(r._x,r._y,r._w,r._h),d.clip(),i=0,s=n.length;s>i;++i)o=n[i],!_[o[0]]&&o._visible&&o.__c.Canvas&&(_[o[0]]=!0,f.push(o));for(f.sort(this._sort),i=0,s=f.length;s>i;++i){o=f[i];var p=o._mbr||o;l(p,r)&&o.draw(),o._changed=!1}d.closePath(),d.restore()}if(e.canvasLayer.debugDirty===!0)for(d.strokeStyle="red",t=0,h=c.length;h>t;++t)r=c[t],d.strokeRect(r._x,r._y,r._w,r._h)},_drawAll:function(t){t=t||e.viewport.rect();var i,n=e.map.search(t),r=0,s=n.length,o=this.context;for(o.clearRect(t._x,t._y,t._w,t._h),n.sort(this._sort);s>r;r++)i=n[r],i._visible&&i.__c.Canvas&&(i.draw(),i._changed=!1)},debug:function(){console.log(this._changedObjs)},_clean:function(){var t,e,i,n,r=this._changedObjs;for(i=0,n=r.length;n>i;i++)e=r[i],t=e._mbr||e,"undefined"==typeof e.staleRect&&(e.staleRect={}),e.staleRect._x=t._x,e.staleRect._y=t._y,e.staleRect._w=t._w,e.staleRect._h=t._h,e._changed=!1;r.length=0,this._dirtyRects.length=0,this._dirtyViewport=!1},_createDirty:function(t){var i=t._mbr||t,n=this._dirtyRects,r=e.rectManager;if(t.staleRect){if(r.overlap(t.staleRect,i))return r.merge(t.staleRect,i,t.staleRect),void n.push(t.staleRect);n.push(t.staleRect)}t.currentRect._x=i._x,t.currentRect._y=i._y,t.currentRect._w=i._w,t.currentRect._h=i._h,n.push(t.currentRect)},_resize:function(){var t=e.canvasLayer._canvas;t.width=e.viewport.width,t.height=e.viewport.height},_setPixelart:function(t){var i=e.canvasLayer.context;i.imageSmoothingEnabled=!t,i.mozImageSmoothingEnabled=!t,i.webkitImageSmoothingEnabled=!t,i.oImageSmoothingEnabled=!t,i.msImageSmoothingEnabled=!t}}})},{"../core/core.js":7}],19:[function(t){var e=t("../core/core.js");e.c("Canvas",{init:function(){var t=e.canvasLayer;t.context||t.init(),this._drawLayer=t,this._drawContext=t.context,t.layerCount++,this.currentRect={},this._changed=!0,t.add(this),this.bind("Invalidate",function(){this._changed===!1&&(this._changed=!0,t.add(this))}),this.bind("Remove",function(){this._drawLayer.layerCount--,this._changed=!0,this._drawLayer.add(this)})},drawVars:{type:"canvas",pos:{},ctx:null,coord:[0,0,0,0],co:{x:0,y:0,w:0,h:0}},draw:function(t,e,i,n,r){if(this.ready){4===arguments.length&&(r=n,n=i,i=e,e=t,t=this._drawContext);var s=this.drawVars.pos;s._x=this._x+(e||0),s._y=this._y+(i||0),s._w=n||this._w,s._h=r||this._h,context=t||this._drawContext,coord=this.__coord||[0,0,0,0];var o=this.drawVars.co;o.x=coord[0]+(e||0),o.y=coord[1]+(i||0),o.w=n||coord[2],o.h=r||coord[3],(this._flipX||this._flipY||this._rotation)&&context.save(),0!==this._rotation&&(context.translate(this._origin.x+this._x,this._origin.y+this._y),s._x=-this._origin.x,s._y=-this._origin.y,context.rotate(this._rotation%360*(Math.PI/180))),(this._flipX||this._flipY)&&(context.scale(this._flipX?-1:1,this._flipY?-1:1),this._flipX&&(s._x=-(s._x+s._w)),this._flipY&&(s._y=-(s._y+s._h)));var a;return this._alpha<1&&(a=context.globalAlpha,context.globalAlpha=this._alpha),this.drawVars.ctx=context,this.trigger("Draw",this.drawVars),(0!==this._rotation||this._flipX||this._flipY)&&context.restore(),a&&(context.globalAlpha=a),this}}})},{"../core/core.js":7}],20:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({assignColor:function(){function t(t){return t._red=t._blue=t._green=0,t}function e(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e}function n(t,i,n){return"#"+e(t)+e(i)+e(n)}function r(e,i){var n;if(7===e.length)n=2;else{if(4!==e.length)return t(i);n=1}return i._red=parseInt(e.substr(1,n),16),i._green=parseInt(e.substr(1+n,n),16),i._blue=parseInt(e.substr(1+2*n,n),16),i}function s(e,i){var n=l.exec(e);return null===n||4!=n.length&&5!=n.length?t(i):(i._red=Math.round(parseFloat(n[1])),i._green=Math.round(parseFloat(n[2])),i._blue=Math.round(parseFloat(n[3])),n[4]&&(i._strength=parseFloat(n[4])),i)}function o(t,e){if("undefined"==typeof u[t]){c===!1&&(window.document.body.appendChild(h),c=!0),h.style.color=t;var i=window.getComputedStyle(h).color;s(i,e),u[t]=n(e._red,e._green,e._blue)}else r(u[t],e);return e}function a(t){return"rgba("+t._red+", "+t._green+", "+t._blue+", "+t._strength+")"}var h=i.createElement("div");h.style.display="none";var c=!1,u={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#00ff00",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},l=/rgba?\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,?\s*([0-9.]+)?\)/;return function(t,e){e=e||{},t=t.trim().toLowerCase();var i=null;i="#"===t[0]?r(t,e):"r"===t[0]&&"g"===t[1]&&"b"===t[2]?s(t,e):o(t,e),e._strength=e._strength||1,e._color=a(e)}}()});var n=(t("fs"),"attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec4 aColor;\n\nvarying lowp vec4 vColor;\n\nuniform  vec4 uViewport;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n\n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vColor = vec4(aColor.rgb*aColor.a*aLayer.y, aColor.a*aLayer.y);\n}"),r="precision mediump float;\nvarying lowp vec4 vColor;\nvoid main(void) {\n	gl_FragColor = vColor;\n}",s=[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aColor",width:4}];e.c("Color",{_red:0,_green:0,_blue:0,_strength:1,_color:"",ready:!0,init:function(){this.bind("Draw",this._drawColor),this.has("WebGL")&&this._establishShader("Color",r,n,s),this.trigger("Invalidate")},remove:function(){this.unbind("Draw",this._drawColor),this.has("DOM")&&(this._element.style.backgroundColor="transparent"),this.trigger("Invalidate")},_drawColor:function(t){this._color&&("DOM"===t.type?(t.style.backgroundColor=this._color,t.style.lineHeight=0):"canvas"===t.type?(t.ctx.fillStyle=this._color,t.ctx.fillRect(t.pos._x,t.pos._y,t.pos._w,t.pos._h)):"webgl"===t.type&&t.program.writeVector("aColor",this._red/255,this._green/255,this._blue/255,this._strength))},color:function(t){return 0===arguments.length?this._color:(arguments.length>=3?(this._red=arguments[0],this._green=arguments[1],this._blue=arguments[2],"number"==typeof arguments[3]&&(this._strength=arguments[3])):(e.assignColor(t,this),"number"==typeof arguments[1]&&(this._strength=arguments[1])),this._color="rgba("+this._red+", "+this._green+", "+this._blue+", "+this._strength+")",this.trigger("Invalidate"),this)}})},{"../core/core.js":7,fs:1}],21:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({domHelper:{innerPosition:function(t){var e=t.getBoundingClientRect(),n=e.left+(window.pageXOffset?window.pageXOffset:i.body.scrollLeft),r=e.top+(window.pageYOffset?window.pageYOffset:i.body.scrollTop),s=parseInt(this.getStyle(t,"border-left-width")||0,10)||parseInt(this.getStyle(t,"borderLeftWidth")||0,10)||0,o=parseInt(this.getStyle(t,"border-top-width")||0,10)||parseInt(this.getStyle(t,"borderTopWidth")||0,10)||0;return n+=s,r+=o,{x:n,y:r}},getStyle:function(t,e){var n;return t.currentStyle?n=t.currentStyle[this.camelize(e)]:window.getComputedStyle&&(n=i.defaultView.getComputedStyle(t,null).getPropertyValue(this.csselize(e))),n},camelize:function(t){return t.replace(/-+(.)?/g,function(t,e){return e?e.toUpperCase():""})},csselize:function(t){return t.replace(/[A-Z]/g,function(t){return t?"-"+t.toLowerCase():""})},translate:function(t,n){var r=i.documentElement,s=i.body;return{x:(t-e.stage.x+(r&&r.scrollLeft||s&&s.scrollLeft||0))/e.viewport._scale-e.viewport._x,y:(n-e.stage.y+(r&&r.scrollTop||s&&s.scrollTop||0))/e.viewport._scale-e.viewport._y}}}})},{"../core/core.js":7}],22:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({domLayer:{_changedObjs:[],_dirtyViewport:!1,_div:null,init:function(){var t=this._div=i.createElement("div");e.stage.elem.appendChild(t),t.style.position="absolute",t.style.zIndex="1",t.style.transformStyle="preserve-3d",e.uniqueBind("RenderScene",this._render),e.uniqueBind("PixelartSet",this._setPixelArt),e.uniqueBind("InvalidateViewport",function(){e.domLayer._dirtyViewport=!0})},_setPixelArt:function(t){var i=e.domLayer._div.style,n=e.domHelper.camelize;t?(i[n("image-rendering")]="optimizeSpeed",i[n("image-rendering")]="-moz-crisp-edges",i[n("image-rendering")]="-o-crisp-edges",i[n("image-rendering")]="-webkit-optimize-contrast",i[n("-ms-interpolation-mode")]="nearest-neighbor",i[n("image-rendering")]="optimize-contrast",i[n("image-rendering")]="pixelated",i[n("image-rendering")]="crisp-edges"):(i[n("image-rendering")]="optimizeQuality",i[n("-ms-interpolation-mode")]="bicubic",i[n("image-rendering")]="auto")},debug:function(){console.log(this._changedObjs)},_render:function(){var t=e.domLayer,i=t._changedObjs;if(t._dirtyViewport&&(t._setViewport(),t._dirtyViewport=!1),i.length){for(var n=0,r=i.length;r>n;++n)i[n].draw()._changed=!1;i.length=0}},add:function(t){this._changedObjs.push(t)},_setViewport:function(){var t=e.domLayer._div.style,i=e.viewport;t.transform=t[e.support.prefix+"Transform"]="scale("+i._scale+", "+i._scale+")",t.left=Math.round(i._x*i._scale)+"px",t.top=Math.round(i._y*i._scale)+"px",t.zIndex=10}}})},{"../core/core.js":7}],23:[function(t){var e=t("../core/core.js"),i=window.document;e.c("DOM",{_element:null,_cssStyles:null,avoidCss3dTransforms:!1,init:function(){var t=e.domLayer;t._div||t.init(),this._drawLayer=t,this._cssStyles={visibility:"",left:"",top:"",width:"",height:"",zIndex:"",opacity:"",transformOrigin:"",transform:""},this._element=i.createElement("div"),t._div.appendChild(this._element),this._element.style.position="absolute",this._element.id="ent"+this[0],this.bind("Invalidate",this._invalidateDOM),this.bind("NewComponent",this._updateClass),this.bind("RemoveComponent",this._removeClass),this._invalidateDOM()},remove:function(){this.undraw(),this.unbind("NewComponent",this._updateClass),this.unbind("RemoveComponent",this._removeClass),this.unbind("Invalidate",this._invalidateDOM)},getDomId:function(){return this._element.id},_removeClass:function(t){var e=0,i=this.__c,n="";for(e in i)e!=t&&(n+=" "+e);n=n.substr(1),this._element.className=n},_updateClass:function(){var t=0,e=this.__c,i="";for(t in e)i+=" "+t;i=i.substr(1),this._element.className=i},_invalidateDOM:function(){this._changed||(this._changed=!0,this._drawLayer.add(this))},DOM:function(t){return t&&t.nodeType&&(this.undraw(),this._element=t,this._element.style.position="absolute"),this},draw:function(){var t=this._element.style,i=this.__coord||[0,0,0,0],n={x:i[0],y:i[1],w:i[2],h:i[3]},r=e.support.prefix,s=[];if(this._cssStyles.visibility!==this._visible&&(this._cssStyles.visibility=this._visible,t.visibility=this._visible?"visible":"hidden"),e.support.css3dtransform&&!this.avoidCss3dTransforms?s.push("translate3d("+~~this._x+"px,"+~~this._y+"px,0)"):(this._cssStyles.left!==this._x&&(this._cssStyles.left=this._x,t.left=~~this._x+"px"),this._cssStyles.top!==this._y&&(this._cssStyles.top=this._y,t.top=~~this._y+"px")),this._cssStyles.width!==this._w&&(this._cssStyles.width=this._w,t.width=~~this._w+"px"),this._cssStyles.height!==this._h&&(this._cssStyles.height=this._h,t.height=~~this._h+"px"),this._cssStyles.zIndex!==this._z&&(this._cssStyles.zIndex=this._z,t.zIndex=this._z),this._cssStyles.opacity!==this._alpha&&(this._cssStyles.opacity=this._alpha,t.opacity=this._alpha,t[r+"Opacity"]=this._alpha),this._mbr){var o=this._origin.x+"px "+this._origin.y+"px";t.transformOrigin=o,t[r+"TransformOrigin"]=o,s.push(e.support.css3dtransform?"rotateZ("+this._rotation+"deg)":"rotate("+this._rotation+"deg)")}return this._flipX&&s.push("scaleX(-1)"),this._flipY&&s.push("scaleY(-1)"),this._cssStyles.transform!=s.join(" ")&&(this._cssStyles.transform=s.join(" "),t.transform=this._cssStyles.transform,t[r+"Transform"]=this._cssStyles.transform),this.trigger("Draw",{style:t,type:"DOM",co:n}),this},undraw:function(){var t=this._element;return t&&null!==t.parentNode&&t.parentNode.removeChild(t),this},css:function(t,i){var n,r,s=this._element,o=s.style;if("object"==typeof t)for(n in t)t.hasOwnProperty(n)&&(r=t[n],"number"==typeof r&&(r+="px"),o[e.domHelper.camelize(n)]=r);else{if(!i)return e.domHelper.getStyle(s,t);"number"==typeof i&&(i+="px"),o[e.domHelper.camelize(t)]=i}return this.trigger("Invalidate"),this}})},{"../core/core.js":7}],24:[function(t){var e=t("../core/core.js");e.extend({_pixelartEnabled:!1,pixelart:function(t){e._pixelartEnabled=t,e.trigger("PixelartSet",t)}})},{"../core/core.js":7}],25:[function(t){var e=t("../core/core.js"),i=e.TextureManager=function(t,e){this.gl=t,this.webgl=e,this.max_units=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.bound_textures=[],this.registered_textures={},this.active=null};i.prototype={reset:function(){for(var t,e=0;e<this.bound_textures.length;e++)t=this.bound_textures[e],t.unbind();this.bound_textures=[],this.active=null},makeTexture:function(t,e,i){var r=(this.gl,this.webgl),s="texture-(r:"+i+")-"+t;if("undefined"!=typeof this.registered_textures[s])return this.registered_textures[s];var o=new n(this,s);return this.registered_textures[s]=o,this.bindTexture(o),o.setImage(e),o.setFilter(r.texture_filter),o.setRepeat(i),o},smallest:function(){for(var t=1/0,e=null,i=0;i<this.bound_textures.length;i++){var n=this.bound_textures[i];n.size<t&&(t=n.size,e=i)}return e},getAvailableUnit:function(){return this.bound_textures.length<this.max_units?this.bound_textures.length:this.smallest()},bindTexture:function(t){if(null===t.unit){var e=this.getAvailableUnit();this.bound_textures[e]&&this.unbindTexture(this.bound_textures[e]),this.bound_textures[e]=t,t.bind(e)}},unbindTexture:function(t){t.unbind()},setActiveTexture:function(t){this.active!==t.id&&(this.gl.activeTexture(this.gl[t.name]),this.active=t.unit)}};var n=e.TextureWrapper=function(t,e){this.manager=t,this.gl=t.gl,this.glTexture=this.gl.createTexture(),this.id=e,this.active=!1,this.unit=null,this.powerOfTwo=!1};n.prototype={bind:function(t){var e=this.gl;this.unit=t,this.name="TEXTURE"+t,this.manager.setActiveTexture(this),e.bindTexture(e.TEXTURE_2D,this.glTexture)},isActive:function(){return this.manager.active===this.unit},unbind:function(){this.unit=null,this.name=null,this.isActive()&&(this.manager.active=null)},setImage:function(t){if(!this.isActive())throw"Trying to set image of texture that isn't active";this.width=t.width,this.height=t.height,this.size=t.width*t.height,this.powerOfTwo=!(Math.log(t.width)/Math.LN2!=Math.floor(Math.log(t.width)/Math.LN2)||Math.log(t.height)/Math.LN2!=Math.floor(Math.log(t.height)/Math.LN2));var e=this.gl;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)},setFilter:function(t){if(!this.isActive())throw"Trying to set filter of texture that isn't active";var e=this.gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t)},setRepeat:function(t){if(!this.isActive())throw"Trying to set repeat property of texture that isn't active";if(t&&!this.powerOfTwo)throw"Can't create a repeating image whose dimensions aren't a power of 2 in WebGL contexts";var e=this.gl;this.repeatMode=t?e.REPEAT:e.CLAMP_TO_EDGE,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this.repeatMode),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this.repeatMode)},setToProgram:function(t,e,i){if(null===this.unit)throw"Trying to use texture not set to a texture unit.";var n=this.gl;n.useProgram(t),n.uniform1i(n.getUniformLocation(t,e),this.unit),n.uniform2f(n.getUniformLocation(t,i),this.width,this.height)}}},{"../core/core.js":7}],26:[function(t){var e=t("../core/core.js");e.c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(t){return this.inner=t,this._element.innerHTML=t,this},append:function(t){return this.inner+=t,this._element.innerHTML+=t,this},prepend:function(t){return this.inner=t+this.inner,this._element.innerHTML=t+this.inner,this}})},{"../core/core.js":7}],27:[function(t){var e=t("../core/core.js"),i=(t("fs"),"attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec2 aTextureCoord;\n\nvarying mediump vec3 vTextureCoord;\n\nuniform vec4 uViewport;\nuniform mediump vec2 uTextureDimensions;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n  \n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin ;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vTextureCoord = vec3(aTextureCoord, aLayer.y);\n}"),n="varying mediump vec3 vTextureCoord;\n  \nuniform sampler2D uSampler;\nuniform mediump vec2 uTextureDimensions;\n\nvoid main(void) {\n  highp vec2 coord =   vTextureCoord.xy / uTextureDimensions;\n  mediump vec4 base_color = texture2D(uSampler, coord);\n  gl_FragColor = vec4(base_color.rgb*base_color.a*vTextureCoord.z, base_color.a*vTextureCoord.z);\n}",r=[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aTextureCoord",width:2}];e.c("Image",{_repeat:"repeat",ready:!1,init:function(){this.bind("Draw",this._drawImage)},remove:function(){this.unbind("Draw",this._drawImage),this.program&&this.program.unregisterEntity(this)},image:function(t,i){if(this.__image=t,this._repeat=i||"no-repeat",this.img=e.asset(t),this.img)this._onImageLoad();else{this.img=new Image,e.asset(t,this.img),this.img.src=t;var n=this;this.img.onload=function(){n._onImageLoad()}}return this.trigger("Invalidate"),this},_onImageLoad:function(){this.has("Canvas")?this._pattern=this._drawContext.createPattern(this.img,this._repeat):this.has("WebGL")&&(this._establishShader("image:"+this.__image,n,i,r),this.program.setTexture(this.webgl.makeTexture(this.__image,this.img,"no-repeat"!==this._repeat))),"no-repeat"===this._repeat&&(this.w=this.w||this.img.width,this.h=this.h||this.img.height),this.ready=!0,this.trigger("Invalidate")},_drawImage:function(t){if("canvas"===t.type){if(!this.ready||!this._pattern)return;var e=t.ctx;e.fillStyle=this._pattern,e.save(),e.translate(t.pos._x,t.pos._y),e.fillRect(0,0,t.pos._w,t.pos._h),e.restore()}else if("DOM"===t.type)this.__image&&(t.style.backgroundImage="url("+this.__image+")",t.style.backgroundRepeat=this._repeat);else if("webgl"===t.type){var i=t.pos;t.program.writeVector("aTextureCoord",0,0,0,i._h,i._w,0,i._w,i._h)}}})},{"../core/core.js":7,fs:1}],28:[function(t){var e=t("../core/core.js"),i=window.document;e.c("Particles",{init:function(){this._Particles=e.clone(this._Particles),this._Particles.parentEntity=this},particles:function(t){if(!e.support.canvas||e.deactivateParticles)return this;var n,r,s,o,a;n=i.createElement("canvas"),n.width=e.viewport.width,n.height=e.viewport.height,n.style.position="absolute",n.style.left="0px",n.style.top="0px",e.stage.elem.appendChild(n),r=n.getContext("2d"),this._Particles.init(t),this.bind("Remove",function(){e.stage.elem.removeChild(n)}).bind("RemoveComponent",function(t){"particles"===t&&e.stage.elem.removeChild(n)}),s=this.x+e.viewport.x,o=this.y+e.viewport.y,this._Particles.position=this._Particles.vectorHelpers.create(s,o);var h={x:e.viewport.x,y:e.viewport.y};return this.bind("EnterFrame",function(){s=this.x+e.viewport.x,o=this.y+e.viewport.y,this._Particles.viewportDelta={x:e.viewport.x-h.x,y:e.viewport.y-h.y},h={x:e.viewport.x,y:e.viewport.y},this._Particles.position=this._Particles.vectorHelpers.create(s,o),"function"==typeof e.rectManager.boundingRect?(a=e.rectManager.boundingRect(this._Particles.register),a&&r.clearRect(a._x,a._y,a._w,a._h)):r.clearRect(0,0,e.viewport.width,e.viewport.height),this._Particles.update(),this._Particles.render(r)}),this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:.1},jitter:0,originOffset:{x:0,y:0},particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(t){this.position=this.vectorHelpers.create(0,0),"undefined"==typeof t&&(t={});for(var e in this.presets)this[e]="undefined"!=typeof t[e]?t[e]:this.presets[e];this.emissionRate=this.maxParticles/this.lifeSpan,this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount==this.maxParticles)return!1;var t=new this.particle(this.vectorHelpers);return this.initParticle(t),this.particles[this.particleCount]=t,this.particleCount++,!0},RANDM1TO1:function(){return 2*Math.random()-1},initParticle:function(t){t.position.x=e.viewport._scale*(this.position.x+this.originOffset.x+this.positionRandom.x*this.RANDM1TO1()),t.position.y=e.viewport._scale*(this.position.y+this.originOffset.y+this.positionRandom.y*this.RANDM1TO1());
var i=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),n=this.vectorHelpers.create(Math.sin(i),-Math.cos(i)),r=this.speed+this.speedRandom*this.RANDM1TO1();t.direction=this.vectorHelpers.multiply(n,r),t.size=e.viewport._scale*(this.size+this.sizeRandom*this.RANDM1TO1()),t.size=t.size<0?0:~~t.size,t.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1(),t.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1(),t.sharpness=t.sharpness>100?100:t.sharpness<0?0:t.sharpness,t.sizeSmall=~~(t.size/200*t.sharpness);var s=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()],o=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];t.colour=s,t.deltaColour[0]=(o[0]-s[0])/t.timeToLive,t.deltaColour[1]=(o[1]-s[1])/t.timeToLive,t.deltaColour[2]=(o[2]-s[2])/t.timeToLive,t.deltaColour[3]=(o[3]-s[3])/t.timeToLive},update:function(){if(this.active&&this.emissionRate>0){var t=1/this.emissionRate;for(this.emitCounter++;this.particleCount<this.maxParticles&&this.emitCounter>t;)this.addParticle(),this.emitCounter-=t;this.elapsedFrames++,-1!=this.duration&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0,this.register=[];for(var e;this.particleIndex<this.particleCount;){var i=this.particles[this.particleIndex];if(i.timeToLive>0){i.direction=this.vectorHelpers.add(i.direction,this.gravity),i.position=this.vectorHelpers.add(i.position,i.direction),i.position=this.vectorHelpers.add(i.position,this.viewportDelta),this.jitter&&(i.position.x+=this.jitter*this.RANDM1TO1(),i.position.y+=this.jitter*this.RANDM1TO1()),i.timeToLive--;var n=i.colour[0]+=i.deltaColour[0],r=i.colour[1]+=i.deltaColour[1],s=i.colour[2]+=i.deltaColour[2],o=i.colour[3]+=i.deltaColour[3];e=[],e.push("rgba("+(n>255?255:0>n?0:~~n)),e.push(r>255?255:0>r?0:~~r),e.push(s>255?255:0>s?0:~~s),e.push((o>1?1:0>o?0:o.toFixed(2))+")"),i.drawColour=e.join(","),this.fastMode||(e[3]="0)",i.drawColourEnd=e.join(",")),this.particleIndex++}else this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]),this.particleCount--;var a={};a._x=~~i.position.x,a._y=~~i.position.y,a._w=i.size,a._h=i.size,this.register.push(a)}},stop:function(){this.active=!1,this.elapsedFrames=0,this.emitCounter=0,this.parentEntity.trigger("ParticleEnd")},render:function(t){for(var i=0,n=this.particleCount;n>i;i++){var r=this.particles[i],s=r.size,o=s>>1;if(!(r.position.x+s<0||r.position.y+s<0||r.position.x-s>e.viewport.width||r.position.y-s>e.viewport.height)){var a=~~r.position.x,h=~~r.position.y;if(this.fastMode)t.fillStyle=r.drawColour;else{var c=t.createRadialGradient(a+o,h+o,r.sizeSmall,a+o,h+o,o);c.addColorStop(0,r.drawColour),c.addColorStop(.9,r.drawColourEnd),t.fillStyle=c}t.fillRect(a,h,s,s)}}},particle:function(t){this.position=t.create(0,0),this.direction=t.create(0,0),this.size=0,this.sizeSmall=0,this.timeToLive=0,this.colour=[],this.drawColour="",this.deltaColour=[],this.sharpness=0},vectorHelpers:{create:function(t,e){return{x:t,y:e}},multiply:function(t,e){return t.x*=e,t.y*=e,t},add:function(t,e){return t.x+=e.x,t.y+=e.y,t}}}})},{"../core/core.js":7}],29:[function(t){var e=t("../core/core.js");e.c("SpriteAnimation",{_reels:null,_currentReelId:null,_currentReel:null,_isPlaying:!1,animationSpeed:1,init:function(){this._reels={}},reel:function(t,i,n,r,s){if(0===arguments.length)return this._currentReelId;if(1===arguments.length&&"string"==typeof t){if("undefined"==typeof this._reels[t])throw"The specified reel "+t+" is undefined.";return this.pauseAnimation(),this._currentReelId!==t&&(this._currentReelId=t,this._currentReel=this._reels[t],this._updateSprite(),this.trigger("ReelChange",this._currentReel)),this}var o,a,h;if(o={id:t,frames:[],currentFrame:0,easing:new e.easing(i),defaultLoops:1},o.duration=o.easing.duration,"number"==typeof n)if(a=n,h=r,s>=0)for(;n+s>a;a++)o.frames.push([a,h]);else for(;a>n+s;a--)o.frames.push([a,h]);else{if(3!==arguments.length||"object"!=typeof n)throw"Urecognized arguments. Please see the documentation for 'reel(...)'.";o.frames=n}return this._reels[t]=o,this},animate:function(t,e){"string"==typeof t&&this.reel(t);var i=this._currentReel;if("undefined"==typeof i||null===i)throw"No reel is specified, and there is no currently active reel.";return this.pauseAnimation(),"undefined"==typeof e&&(e="number"==typeof t?t:1),i.easing.reset(),this.loops(e),this._setFrame(0),this.bind("EnterFrame",this._animationTick),this._isPlaying=!0,this.trigger("StartAnimation",i),this},resumeAnimation:function(){return this._isPlaying===!1&&null!==this._currentReel&&(this.bind("EnterFrame",this._animationTick),this._isPlaying=!0,this._currentReel.easing.resume(),this.trigger("StartAnimation",this._currentReel)),this},pauseAnimation:function(){return this._isPlaying===!0&&(this.unbind("EnterFrame",this._animationTick),this._isPlaying=!1,this._reels[this._currentReelId].easing.pause()),this},resetAnimation:function(){var t=this._currentReel;if(null===t)throw"No active reel to reset.";return this.reelPosition(0),t.easing.repeat(t.defaultLoops),this},loops:function(t){return 0===arguments.length?null!==this._currentReel?this._currentReel.easing.loops:0:(null!==this._currentReel&&(0>t&&(t=1/0),this._currentReel.easing.repeat(t),this._currentReel.defaultLoops=t),this)},reelPosition:function(t){if(null===this._currentReel)throw"No active reel.";if(0===arguments.length)return this._currentReel.currentFrame;var e,i=this._currentReel.frames.length;if("end"===t&&(t=i-1),1>t&&t>0)e=t,t=Math.floor(i*e);else{if(t!==Math.floor(t))throw"Position "+t+" is invalid.";0>t&&(t=i-1+t),e=t/i}return t=Math.min(t,i-1),t=Math.max(t,0),this._setProgress(e),this._setFrame(t),this},_animationTick:function(t){var e=this._reels[this._currentReelId];e.easing.tick(t.dt*this.animationSpeed);var i=e.easing.value(),n=Math.min(Math.floor(e.frames.length*i),e.frames.length-1);this._setFrame(n),e.easing.complete===!0&&(this.pauseAnimation(),this.trigger("AnimationEnd",this._currentReel))},_setFrame:function(t){var e=this._currentReel;t!==e.currentFrame&&(e.currentFrame=t,this._updateSprite(),this.trigger("FrameChange",e))},_updateSprite:function(){var t=this._currentReel,e=t.frames[t.currentFrame];this.sprite(e[0],e[1])},_setProgress:function(t,e){this._currentReel.easing.setProgress(t,e)},isPlaying:function(t){return this._isPlaying?t?this._currentReelId===t:!!this._currentReelId:!1},getReel:function(t){if(0===arguments.length){if(!this._currentReelId)return null;t=this._currentReelId}return this._reels[t]}})},{"../core/core.js":7}],30:[function(t){var e=t("../core/core.js"),i=(t("fs"),"attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec2 aTextureCoord;\n\nvarying mediump vec3 vTextureCoord;\n\nuniform vec4 uViewport;\nuniform mediump vec2 uTextureDimensions;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n  \n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin ;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vTextureCoord = vec3(aTextureCoord, aLayer.y);\n}"),n="varying mediump vec3 vTextureCoord;\n  \nuniform sampler2D uSampler;\nuniform mediump vec2 uTextureDimensions;\n\nvoid main(void) {\n  highp vec2 coord =   vTextureCoord.xy / uTextureDimensions;\n  mediump vec4 base_color = texture2D(uSampler, coord);\n  gl_FragColor = vec4(base_color.rgb*base_color.a*vTextureCoord.z, base_color.a*vTextureCoord.z);\n}",r=[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aTextureCoord",width:2}];e.extend({sprite:function(t,s,o,a,h,c,u){var l,d,_;"string"==typeof t&&(c=h,h=a,a=s,o=t,t=1,s=1),"string"==typeof s&&(c=h,h=a,a=o,o=s,s=t),!c&&h&&(c=h),h=parseInt(h||0,10),c=parseInt(c||0,10);var f=function(){this.ready=!0,this.trigger("Invalidate")};_=e.asset(o),_||(_=new Image,_.src=o,e.asset(o,_),_.onload=function(){for(var t in a)e(t).each(f)});var p=function(){this.requires("2D, Sprite"),this.__trim=[0,0,0,0],this.__image=o,this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]],this.__tile=t,this.__tileh=s,this.__padding=[h,c],this.__padBorder=u,this.sprite(this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]),this.img=_,this.img.complete&&this.img.width>0&&(this.ready=!0,this.trigger("Invalidate")),this.w=this.__coord[2],this.h=this.__coord[3],this.has("WebGL")&&(this._establishShader(this.__image,n,i,r),this.program.setTexture(this.webgl.makeTexture(this.__image,this.img,!1)))};for(l in a)a.hasOwnProperty(l)&&(d=a[l],e.c(l,{ready:!1,__coord:[d[0],d[1],d[2]||1,d[3]||1],init:p}));return this}}),e.c("Sprite",{__image:"",__tile:0,__tileh:0,__padding:null,__trim:null,img:null,ready:!1,init:function(){this.__trim=[0,0,0,0],this.bind("Draw",this._drawSprite)},remove:function(){this.unbind("Draw",this._drawSprite),this.program&&this.program.unregisterEntity(this)},_drawSprite:function(t){var e=t.co,i=t.pos,n=t.ctx;if("canvas"===t.type)n.drawImage(this.img,e.x,e.y,e.w,e.h,i._x,i._y,i._w,i._h);else if("DOM"===t.type){var r=this._h/e.h,s=this._w/e.w,o=this._element.style,a=o.backgroundColor;"initial"===a&&(a="");var h=a+" url('"+this.__image+"') no-repeat";h!==o.background&&(o.background=h),o.backgroundPosition="-"+e.x*s+"px -"+e.y*r+"px",(1!=r||1!=s)&&(o.backgroundSize=this.img.width*s+"px "+this.img.height*r+"px")}else"webgl"===t.type&&t.program.writeVector("aTextureCoord",e.x,e.y,e.x,e.y+e.h,e.x+e.w,e.y,e.x+e.w,e.y+e.h)},sprite:function(t,e,i,n){return this.__coord=this.__coord||[0,0,0,0],this.__coord[0]=t*(this.__tile+this.__padding[0])+(this.__padBorder?this.__padding[0]:0)+this.__trim[0],this.__coord[1]=e*(this.__tileh+this.__padding[1])+(this.__padBorder?this.__padding[1]:0)+this.__trim[1],"undefined"!=typeof i&&"undefined"!=typeof n&&(this.__coord[2]=this.__trim[2]||i*this.__tile||this.__tile,this.__coord[3]=this.__trim[3]||n*this.__tileh||this.__tileh),this.trigger("Invalidate"),this},crop:function(t,e,i,n){var r=this._mbr||this.pos();return this.__trim=[],this.__trim[0]=t,this.__trim[1]=e,this.__trim[2]=i,this.__trim[3]=n,this.__coord[0]+=t,this.__coord[1]+=e,this.__coord[2]=i,this.__coord[3]=n,this._w=i,this._h=n,this.trigger("Invalidate",r),this}})},{"../core/core.js":7,fs:1}],31:[function(t){var e=t("../core/core.js");e.c("Text",{_text:"",defaultSize:"10px",defaultFamily:"sans-serif",defaultVariant:"normal",defaultLineHeight:"normal",ready:!0,init:function(){this.requires("2D"),this._textFont={type:"",weight:"",size:this.defaultSize,lineHeight:this.defaultLineHeight,family:this.defaultFamily,variant:this.defaultVariant},this.bind("Draw",function(t){var e=this._fontString();if("DOM"===t.type){var i=this._element,n=i.style;n.color=this._textColor,n.font=e,i.innerHTML=this._text}else if("canvas"===t.type){var r=t.ctx;r.save(),r.textBaseline="top",r.fillStyle=this._textColor||"rgb(0,0,0)",r.font=e,r.fillText(this._text,t.pos._x,t.pos._y),r.restore()}})},_getFontHeight:function(){var t=/([a-zA-Z]+)\b/,e={px:1,pt:4/3,pc:16,cm:96/2.54,mm:96/25.4,"in":96,em:void 0,ex:void 0};return function(i){var n=parseFloat(i),r=t.exec(i),s=r?r[1]:"px";return Math.ceil(void 0!==e[s]?n*e[s]:n)}}(),text:function(t){return"undefined"==typeof t||null===t?this._text:(this._text="function"==typeof t?t.call(this):t,this.has("Canvas")&&this._resizeForCanvas(),this.trigger("Invalidate"),this)},_resizeForCanvas:function(){var t=this._drawContext;t.font=this._fontString(),this.w=t.measureText(this._text).width;var e=this._textFont.size||this.defaultSize;this.h=1.1*this._getFontHeight(e)},_fontString:function(){return this._textFont.type+" "+this._textFont.variant+" "+this._textFont.weight+" "+this._textFont.size+" / "+this._textFont.lineHeight+" "+this._textFont.family},textColor:function(t){return e.assignColor(t,this),this._textColor="rgba("+this._red+", "+this._green+", "+this._blue+", "+this._strength+")",this.trigger("Invalidate"),this},textFont:function(t,e){if(1===arguments.length){if("string"==typeof t)return this._textFont[t];if("object"==typeof t)for(var i in t)this._textFont[i]="family"==i?"'"+t[i]+"'":t[i]}else this._textFont[t]=e;return this.has("Canvas")&&this._resizeForCanvas(),this.trigger("Invalidate"),this},unselectable:function(){return this.has("DOM")&&(this.css({"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",cursor:"default"}),this.trigger("Invalidate")),this}})},{"../core/core.js":7}],32:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({viewport:{clampToEntities:!0,_width:0,_height:0,_x:0,_y:0,_scale:1,bounds:null,scroll:function(t,i){this[t]=i,e.trigger("ViewportScroll"),e.trigger("InvalidateViewport")},rect_object:{_x:0,_y:0,_w:0,_h:0},rect:function(){return this.rect_object._x=-this._x,this.rect_object._y=-this._y,this.rect_object._w=this._width/this._scale,this.rect_object._h=this._height/this._scale,this.rect_object},pan:function(){function t(t){a.tick(t.dt);var h=a.value();e.viewport.x=(1-h)*s+h*n,e.viewport.y=(1-h)*o+h*r,e.viewport._clamp(),a.complete&&(i(),e.trigger("CameraAnimationDone"))}function i(){e.unbind("EnterFrame",t)}var n,r,s,o,a;return e.bind("StopCamera",i),function(i,h,c,u){e.trigger("StopCamera"),"reset"!=i&&(s=e.viewport._x,o=e.viewport._y,n=s-i,r=o-h,a=new e.easing(c,u),e.uniqueBind("EnterFrame",t))}}(),follow:function(){function t(){e.viewport.scroll("_x",-(this.x+this.w/2-e.viewport.width/2-r)),e.viewport.scroll("_y",-(this.y+this.h/2-e.viewport.height/2-s)),e.viewport._clamp()}function i(){n&&n.unbind("Move",t)}var n,r,s;return e.bind("StopCamera",i),function(i,o,a){i&&i.has("2D")&&(e.trigger("StopCamera"),n=i,r="undefined"!=typeof o?o:0,s="undefined"!=typeof a?a:0,i.bind("Move",t),t.call(i))}}(),centerOn:function(t,i){var n=t.x+e.viewport.x,r=t.y+e.viewport.y,s=t.w/2,o=t.h/2,a=e.viewport.width/2,h=e.viewport.height/2,c=n+s-a,u=r+o-h;e.viewport.pan(c,u,i)},zoom:function(){function t(){e.unbind("EnterFrame",i)}function i(i){var r,l;u.tick(i.dt),r=Math.pow(s,u.value()),l=1===s?u.value():(1/r-1)/(1/s-1),e.viewport.scale(r*n),e.viewport.scroll("_x",o*(1-l)+a*l),e.viewport.scroll("_y",h*(1-l)+c*l),e.viewport._clamp(),u.complete&&(t(),e.trigger("CameraAnimationDone"))}e.bind("StopCamera",t);var n,r,s,o,a,h,c,u;return function(t,l,d,_,f){return t?(arguments.length<=2&&(_=l,l=e.viewport.x-e.viewport.width,d=e.viewport.y-e.viewport.height),e.trigger("StopCamera"),n=e.viewport._scale,s=t,r=n*s,o=e.viewport.x,h=e.viewport.y,a=-(l-e.viewport.width/(2*r)),c=-(d-e.viewport.height/(2*r)),u=new e.easing(_,f),void e.uniqueBind("EnterFrame",i)):void e.viewport.scale(1)}}(),scale:function(){return function(t){this._scale=t?t:1,e.trigger("InvalidateViewport"),e.trigger("ViewportScale")}}(),mouselook:function(){var t=!1,i=!1,n={};return old={},function(r,s){if("boolean"==typeof r)return t=r,void(t?e.mouseObjs++:e.mouseObjs=Math.max(0,e.mouseObjs-1));if(t)switch(r){case"move":case"drag":if(!i)return;diff={x:s.clientX-n.x,y:s.clientY-n.y},n.x=s.clientX,n.y=s.clientY,e.viewport.x+=diff.x,e.viewport.y+=diff.y,e.viewport._clamp();break;case"start":e.trigger("StopCamera"),n.x=s.clientX,n.y=s.clientY,i=!0;break;case"stop":i=!1}}}(),_clamp:function(){if(this.clampToEntities){var t=this.bounds||e.map.boundaries();t.max.x*=this._scale,t.min.x*=this._scale,t.max.y*=this._scale,t.min.y*=this._scale,t.max.x-t.min.x>e.viewport.width?e.viewport.x<-t.max.x+e.viewport.width?e.viewport.x=-t.max.x+e.viewport.width:e.viewport.x>-t.min.x&&(e.viewport.x=-t.min.x):e.viewport.x=-1*(t.min.x+(t.max.x-t.min.x)/2-e.viewport.width/2),t.max.y-t.min.y>e.viewport.height?e.viewport.y<-t.max.y+e.viewport.height?e.viewport.y=-t.max.y+e.viewport.height:e.viewport.y>-t.min.y&&(e.viewport.y=-t.min.y):e.viewport.y=-1*(t.min.y+(t.max.y-t.min.y)/2-e.viewport.height/2)}},init:function(t,n,r){this._defineViewportProperties(),this._width=t||window.innerWidth,this._height=n||window.innerHeight,"undefined"==typeof r&&(r="cr-stage");var s;if("string"==typeof r)s=i.getElementById(r);else{if(!("undefined"!=typeof HTMLElement?r instanceof HTMLElement:r instanceof Element))throw new TypeError("stage_elem must be a string or an HTMLElement");s=r}e.stage={x:0,y:0,fullscreen:!1,elem:s?s:i.createElement("div")},t||n||(i.body.style.overflow="hidden",e.stage.fullscreen=!0),e.addEvent(this,window,"resize",e.viewport.reload),e.addEvent(this,window,"blur",function(){e.settings.get("autoPause")&&(e._paused||e.pause())}),e.addEvent(this,window,"focus",function(){e._paused&&e.settings.get("autoPause")&&e.pause()}),e.settings.register("stageSelectable",function(t){e.stage.elem.onselectstart=t?function(){return!0}:function(){return!1}}),e.settings.modify("stageSelectable",!1),e.settings.register("stageContextMenu",function(t){e.stage.elem.oncontextmenu=t?function(){return!0}:function(){return!1}}),e.settings.modify("stageContextMenu",!1),e.settings.register("autoPause",function(){}),e.settings.modify("autoPause",!1),s||(i.body.appendChild(e.stage.elem),e.stage.elem.id=r);var o,a=e.stage.elem.style;if(a.width=this.width+"px",a.height=this.height+"px",a.overflow="hidden",e.bind("ViewportResize",function(){e.trigger("InvalidateViewport")}),e.mobile){void 0!==typeof a.webkitTapHighlightColor&&(a.webkitTapHighlightColor="rgba(0,0,0,0)");var h=i.createElement("meta"),c=i.getElementsByTagName("head")[0];h=i.createElement("meta"),h.setAttribute("name","apple-mobile-web-app-capable"),h.setAttribute("content","yes"),c.appendChild(h),e.addEvent(this,e.stage.elem,"touchmove",function(t){t.preventDefault()})}a.position="relative",o=e.domHelper.innerPosition(e.stage.elem),e.stage.x=o.x,e.stage.y=o.y,e.uniqueBind("ViewportResize",this._resize)},_resize:function(){e.stage.elem.style.width=e.viewport.width+"px",e.stage.elem.style.height=e.viewport.height+"px"},_defineViewportProperties:function(){Object.defineProperty(this,"x",{set:function(t){this.scroll("_x",t)},get:function(){return this._x},configurable:!0}),Object.defineProperty(this,"y",{set:function(t){this.scroll("_y",t)},get:function(){return this._y},configurable:!0}),Object.defineProperty(this,"width",{set:function(t){this._width=t,e.trigger("ViewportResize")},get:function(){return this._width},configurable:!0}),Object.defineProperty(this,"height",{set:function(t){this._height=t,e.trigger("ViewportResize")},get:function(){return this._height},configurable:!0})},reload:function(){var t,i=window.innerWidth,n=window.innerHeight;e.stage.fullscreen&&(this._width=i,this._height=n,e.trigger("ViewportResize")),t=e.domHelper.innerPosition(e.stage.elem),e.stage.x=t.x,e.stage.y=t.y},reset:function(){e.viewport.mouselook("stop"),e.trigger("StopCamera"),e.viewport.scroll("_x",0),e.viewport.scroll("_y",0),e.viewport.scale(1)},onScreen:function(t){return e.viewport._x+t._x+t._w>0&&e.viewport._y+t._y+t._h>0&&e.viewport._x+t._x<e.viewport.width&&e.viewport._y+t._y<e.viewport.height}}})},{"../core/core.js":7}],33:[function(t){var e=t("../core/core.js"),i=window.document;RenderProgramWrapper=function(t,e){this.shader=e,this.context=t,this.array_size=16,this.max_size=1024,this._indexArray=new Uint16Array(6*this.array_size),this._indexBuffer=t.createBuffer()},RenderProgramWrapper.prototype={initAttributes:function(t){this.attributes=t,this._attribute_table={};for(var e=0,i=0;i<t.length;i++){var n=t[i];this._attribute_table[n.name]=n,n.bytes=n.bytes||Float32Array.BYTES_PER_ELEMENT,n.type=n.type||this.context.FLOAT,n.offset=e,n.location=this.context.getAttribLocation(this.shader,n.name),this.context.enableVertexAttribArray(n.location),e+=n.width}this.stride=e,this._attributeArray=new Float32Array(4*this.array_size*this.stride),this._attributeBuffer=this.context.createBuffer(),this._registryHoles=[],this._registrySize=0},growArrays:function(t){if(!(this.array_size>=this.max_size)){var e=Math.min(t,this.max_size),i=new Float32Array(4*e*this.stride),n=new Uint16Array(6*e);i.set(this._attributeArray),n.set(this._indexArray),this._attributeArray=i,this._indexArray=n,this.array_size=e}},registerEntity:function(t){if(0===this._registryHoles.length){if(this._registrySize>=this.max_size)throw"Number of entities exceeds maximum limit.";this._registrySize>=this.array_size&&this.growArrays(2*this.array_size),t._glBufferIndex=this._registrySize,this._registrySize++}else t._glBufferIndex=this._registryHoles.pop()},unregisterEntity:function(t){"number"==typeof t._glBufferIndex&&this._registryHoles.push(t._glBufferIndex),t._glBufferIndex=null},resetRegistry:function(){this._maxElement=0,this._registryHoles.length=0},setCurrentEntity:function(t){this.ent_offset=4*t._glBufferIndex,this.ent=t},switchTo:function(){var t=this.context;t.useProgram(this.shader),t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer);for(var i,n=this.attributes,r=0;r<n.length;r++)i=n[r],t.vertexAttribPointer(i.location,i.width,i.type,!1,this.stride*i.bytes,i.offset*i.bytes);var s=this.texture_obj;s&&null===s.unit&&e.webgl.texture_manager.bindTexture(s),this.index_pointer=0},setTexture:function(t){void 0===this.texture_obj&&(t.setToProgram(this.shader,"uSampler","uTextureDimensions"),this.texture_obj=t)},addIndices:function(t){var e=this._indexArray,i=this.index_pointer;e[0+i]=0+t,e[1+i]=1+t,e[2+i]=2+t,e[3+i]=1+t,e[4+i]=2+t,e[5+i]=3+t,this.index_pointer+=6},renderBatch:function(){var t=this.context;t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer),t.bufferData(t.ARRAY_BUFFER,this._attributeArray,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexArray,t.STATIC_DRAW),t.drawElements(t.TRIANGLES,this.index_pointer,t.UNSIGNED_SHORT,0)},setViewportUniforms:function(t){var e=this.context;e.useProgram(this.shader),e.uniform4f(this.shader.viewport,t._x,t._y,t._width/t._scale,t._height/t._scale)},writeVector:function(t){for(var e=this._attribute_table[t],i=this.stride,n=e.offset+this.ent_offset*i,r=e.width,s=arguments.length-1,o=this._attributeArray,a=0;4>a;a++)for(var h=0;r>h;h++)o[n+i*a+h]=arguments[(r*a+h)%s+1]}},e.c("WebGL",{init:function(){e.webgl.context||e.webgl.init();{var t=this.webgl=e.webgl;t.context}this._changed=!0,this.bind("Change",this._glChange)},remove:function(){this._changed=!0,this.unbind(this._glChange)},_glChange:function(){this._changed===!1&&(this._changed=!0)},drawVars:{type:"webgl",pos:{},ctx:null,coord:[0,0,0,0],co:{x:0,y:0,w:0,h:0}},draw:function(t,e,i,n,r){if(this.ready){4===arguments.length&&(r=n,n=i,i=e,e=t,t=this.webgl.context);var s=this.drawVars.pos;s._x=this._x+(e||0),s._y=this._y+(i||0),s._w=n||this._w,s._h=r||this._h;var o=this.__coord||[0,0,0,0],a=this.drawVars.co;a.x=o[0]+(e||0),a.y=o[1]+(i||0),a.w=n||o[2],a.h=r||o[3],this._flipX&&(a.x=a.x+a.w,a.w=-a.w),this._flipY&&(a.y=a.y+a.h,a.h=-a.h);var h=this.webgl.context;this.drawVars.gl=h;var c=this.drawVars.program=this.program;return c.setCurrentEntity(this),c.writeVector("aPosition",this._x,this._y,this._x,this._y+this._h,this._x+this._w,this._y,this._x+this._w,this._y+this._h),c.writeVector("aOrientation",this._origin.x+this._x,this._origin.y+this._y,this._rotation*Math.PI/180),c.writeVector("aLayer",this._globalZ,this._alpha),this.trigger("Draw",this.drawVars),c.addIndices(c.ent_offset),this}},_establishShader:function(t,e,i,n){this.program=this.webgl.getProgramWrapper(t,e,i,n),this.program.registerEntity(this),this.ready=!0}}),e.extend({webgl:{context:null,changed_objects:[],_compileShader:function(t,e){var i=this.context,n=i.createShader(e);if(i.shaderSource(n,t),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw i.getShaderInfoLog(n);return n},_makeProgram:function(t,e){var i=this.context,n=this._compileShader(t,i.FRAGMENT_SHADER),r=this._compileShader(e,i.VERTEX_SHADER),s=i.createProgram();if(i.attachShader(s,r),i.attachShader(s,n),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS))throw"Could not initialise shaders";return s.viewport=i.getUniformLocation(s,"uViewport"),s},programs:{},getProgramWrapper:function(t,i,n,r){if(void 0===this.programs[t]){var s=this._makeProgram(i,n),o=new RenderProgramWrapper(this.context,s);o.name=t,o.initAttributes(r),o.setViewportUniforms(e.viewport),this.programs[t]=o}return this.programs[t]},makeTexture:function(t,e,i){var n=this;return n.texture_manager.makeTexture(t,e,i)},init:function(){if(!e.support.webgl)return e.trigger("NoWebGL"),void e.stop();var t;t=i.createElement("canvas"),t.width=e.viewport.width,t.height=e.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px",e.stage.elem.appendChild(t);var n;try{n=t.getContext("webgl",{premultipliedalpha:!0})||t.getContext("experimental-webgl",{premultipliedalpha:!0}),n.viewportWidth=t.width,n.viewportHeight=t.height}catch(r){return e.trigger("NoWebGL"),void e.stop()}this.context=n,this._canvas=t,n.clearColor(0,0,0,0),n.disable(n.DEPTH_TEST),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA),n.enable(n.BLEND);var s=this;e.uniqueBind("RenderScene",s.render),e.uniqueBind("ViewportResize",s._resize),e.uniqueBind("InvalidateViewport",function(){s.dirtyViewport=!0}),e.uniqueBind("PixelartSet",s._setPixelart),s._setPixelart(e._pixelartEnabled),this.dirtyViewport=!0,this.texture_manager=new e.TextureManager(n,this)},_resize:function(){var t=e.webgl._canvas;t.width=e.viewport.width,t.height=e.viewport.height;var i=e.webgl.context;i.viewportWidth=t.width,i.viewportHeight=t.height},_setPixelart:function(t){var i=e.webgl.context;e.webgl.texture_filter=t?i.NEAREST:i.LINEAR},zsort:function(t,e){return t._globalZ-e._globalZ},visible_gl:[],render:function(t){t=t||e.viewport.rect();var i=e.webgl,n=i.context;n.viewport(0,0,n.viewportWidth,n.viewportHeight),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var r=i.programs;if(i.dirtyViewport){for(var s in r)r[s].setViewportUniforms(e.viewport);i.dirtyViewport=!1}var o,a=e.map.search(t),h=0,c=a.length,u=i.visible_gl;for(u.length=0,h=0;c>h;h++)o=a[h],o._visible&&o.__c.WebGL&&o.program&&u.push(o);u.sort(i.zsort),c=u.length;var l=null;for(h=0;c>h;h++)o=u[h],l!==o.program&&(null!==l&&l.renderBatch(),l=o.program,l.index_pointer=0,l.switchTo()),o.draw(),o._changed=!1;null!==l&&l.renderBatch()}}})},{"../core/core.js":7}],34:[function(t){var e=t("../core/core.js");e.extend({diamondIso:{_tile:{width:0,height:0,r:0},_map:{width:0,height:0,x:0,y:0},_origin:{x:0,y:0},init:function(t,e,i,n){return this._tile.width=parseInt(t,10),this._tile.height=parseInt(e,10)||parseInt(t,10)/2,this._tile.r=this._tile.width/this._tile.height,this._map.width=parseInt(i,10),this._map.height=parseInt(n,10)||parseInt(i,10),this._origin.x=this._map.height*this._tile.width/2,this},place:function(t,e,i,n){var r=this.pos2px(e,i);n||(n=1);var s=0,o=0;void 0!==t.__margin&&(s=t.__margin[0],o=t.__margin[1]),t.x=r.left+s,t.y=r.top+o-t.h,t.z=r.top*n},centerAt:function(t,i){var n=this.pos2px(t,i);e.viewport.x=-n.left+e.viewport.width/2-this._tile.width,e.viewport.y=-n.top+e.viewport.height/2},area:function(t){t||(t=0);var i=e.viewport.rect(),n=i._x,r=i._y,s=i._w,o=i._h,a=t*this._tile.width,h=t*this._tile.height;n-=this._tile.width/2+a,r-=this._tile.height/2+h,s+=this._tile.width/2+a,o+=this._tile.height/2+h;var c=[];for(yl=r+o;yl>r;r+=this._tile.height/2)for(xl=n+s;xl>n;n+=this._tile.width/2){var u=this.px2pos(n,r);c.push([~~u.x,~~u.y])}return c},pos2px:function(t,e){return{left:(t-e)*this._tile.width/2+this._origin.x,top:(t+e)*this._tile.height/2}},px2pos:function(t,e){var i=(t-this._origin.x)/this._tile.r;return{x:(e+i)/this._tile.height,y:(e-i)/this._tile.height}},polygon:function(t){t.requires("Collision");var i=0,n=0;void 0!==t.__margin&&(i=t.__margin[0],n=t.__margin[1]);var r=[[i-0,t.h-n-this._tile.height/2],[i-this._tile.width/2,t.h-n-0],[i-this._tile.width,t.h-n-this._tile.height/2],[i-this._tile.width/2,t.h-n-this._tile.height]],s=new e.polygon(r);return s}}})},{"../core/core.js":7}],35:[function(t){var e=t("../core/core.js");e.extend({isometric:{_tile:{width:0,height:0},_elements:{},_pos:{x:0,y:0},_z:0,size:function(t,e){return this._tile.width=t,this._tile.height=e>0?e:t/2,this},place:function(t,i,n,r){var s=this.pos2px(t,i);return s.top-=n*(this._tile.height/2),r.attr({x:s.left+e.viewport._x,y:s.top+e.viewport._y}).z+=n,this},pos2px:function(t,e){return{left:t*this._tile.width+(1&e)*(this._tile.width/2),top:e*this._tile.height/2}},px2pos:function(t,e){return{x:-Math.ceil(-t/this._tile.width-.5*(1&e)),y:e/this._tile.height*2}},centerAt:function(t,i){if("number"==typeof t&&"number"==typeof i){var n=this.pos2px(t,i);return e.viewport._x=-n.left+e.viewport.width/2-this._tile.width/2,e.viewport._y=-n.top+e.viewport.height/2-this._tile.height/2,this}return{top:-e.viewport._y+e.viewport.height/2-this._tile.height/2,left:-e.viewport._x+e.viewport.width/2-this._tile.width/2}},area:function(){var t=this.centerAt(),i=this.px2pos(-t.left+e.viewport.width/2,-t.top+e.viewport.height/2),n=this.px2pos(-t.left-e.viewport.width/2,-t.top-e.viewport.height/2);return{x:{start:i.x,end:n.x},y:{start:i.y,end:n.y}}}}})},{"../core/core.js":7}],36:[function(t){var e=t("../core/core.js"),i=window.document;e.extend({audio:{sounds:{},supported:null,codecs:{ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',webma:'audio/webm; codecs="vorbis"',mp3:'audio/mpeg; codecs="mp3"',m4a:'audio/mp4; codecs="mp4a.40.2"'},volume:1,muted:!1,paused:!1,playCheck:null,_canPlay:function(){if(this.supported={},e.support.audio){var t,i=this.audioElement();for(var n in this.codecs)t=i.canPlayType(this.codecs[n]),this.supported[n]=""!==t&&"no"!==t?!0:!1}},supports:function(t){return null===this.supported&&this._canPlay(),this.supported[t]?!0:!1},audioElement:function(){return"undefined"!=typeof Audio?new Audio(""):i.createElement("audio")},create:function(t,i){var n=i.substr(i.lastIndexOf(".")+1).toLowerCase();if(!this.supports(n))return!1;var r=this.audioElement();return r.id=t,r.preload="auto",r.volume=e.audio.volume,r.src=i,e.asset(i,r),this.sounds[t]={obj:r,played:0,volume:e.audio.volume},this.sounds[t]},add:function(t,i){if(e.support.audio){var n,r;if(1===arguments.length&&"object"==typeof t)for(var s in t)for(n in t[s])if(r=e.audio.create(s,t[s][n]))break;if("string"==typeof t&&("string"==typeof i&&(r=e.audio.create(t,i)),"object"==typeof i))for(n in i)if(r=e.audio.create(t,i[n]))break;return r}},play:function(t,i,n){if(0!==i&&e.support.audio&&this.sounds[t]){var r=this.sounds[t],s=this.getOpenChannel();if(!s)return null;s.id=t,s.repeat=i;var o=s.obj;return s.volume=r.volume=r.obj.volume=n||e.audio.volume,o.volume=r.volume,o.src=r.obj.src,this.muted&&(o.volume=0),o.play(),r.played++,s.onEnd=function(){r.played<s.repeat||-1==i?(this.currentTime&&(this.currentTime=0),this.play(),r.played++):(s.active=!1,this.pause(),this.removeEventListener("ended",s.onEnd,!0),this.currentTime=0,e.trigger("SoundComplete",{id:s.id}))},o.addEventListener("ended",s.onEnd,!0),o}},maxChannels:7,setChannels:function(t){this.maxChannels=t,t<this.channels.length&&(this.channels.length=t)},channels:[],getOpenChannel:function(){for(var t=0;t<this.channels.length;t++){var e=this.channels[t];if(e.active===!1||e.obj.ended&&e.repeat<=this.sounds[e.id].played)return e.active=!0,e}if(t<this.maxChannels){var i={obj:this.audioElement(),active:!0,_is:function(t){return this.id===t&&this.active}};return this.channels.push(i),i}return null},remove:function(t){if(e.support.audio){var i,n,r=e.paths().audio;
if(t)this.sounds[t]&&(i=this.sounds[t],n=i.obj.src.split("/").pop(),e.audio.stop(t),delete e.assets[r+n],delete e.assets[i.obj.src],delete e.audio.sounds[t]);else for(var s in this.sounds)i=this.sounds[s],n=i.obj.src.split("/").pop(),e.audio.stop(t),delete e.assets[r+n],delete e.assets[i.obj.src],delete e.audio.sounds[t]}},stop:function(t){if(e.support.audio)for(var i in this.channels)c=this.channels[i],(!t&&c.active||c._is(t))&&(c.active=!1,c.obj.pause())},_mute:function(t){if(e.support.audio){var i;for(var n in this.channels)i=this.channels[n],i.obj.volume=t?0:i.volume;this.muted=t}},toggleMute:function(){this._mute(this.muted?!1:!0)},mute:function(){this._mute(!0)},unmute:function(){this._mute(!1)},pause:function(t){if(e.support.audio&&t&&this.sounds[t]){var i;for(var n in this.channels)i=this.channels[n],i._is(t)&&!i.obj.paused&&i.obj.pause()}},unpause:function(t){if(e.support.audio&&t&&this.sounds[t]){var i;for(var n in this.channels)i=this.channels[n],i._is(t)&&i.obj.paused&&i.obj.play()}},togglePause:function(t){if(e.support.audio&&t&&this.sounds[t]){var i;for(var n in this.channels)i=this.channels[n],i._is(t)&&(i.obj.paused?i.obj.play():i.obj.pause())}},isPlaying:function(t){if(!e.support.audio)return!1;for(var i in this.channels)if(this.channels[i]._is(t))return!0;return!1}}})},{"../core/core.js":7}],37:[function(t){var e=t("../core/core.js"),i=t("./spatial-grid.js");e.map=new i;var n=Math,r=(n.cos,n.sin,n.PI),s=r/180;e.extend({zeroFill:function(t,e){return e-=t.toString().length,e>0?new Array(e+(/\./.test(t)?2:1)).join("0")+t:t.toString()}}),e.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:!0,_globalZ:null,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:!1,_2D_property_definitions:{x:{set:function(t){this._attr("_x",t)},get:function(){return this._x},configurable:!0,enumerable:!0},_x:{enumerable:!1},y:{set:function(t){this._attr("_y",t)},get:function(){return this._y},configurable:!0,enumerable:!0},_y:{enumerable:!1},w:{set:function(t){this._attr("_w",t)},get:function(){return this._w},configurable:!0,enumerable:!0},_w:{enumerable:!1},h:{set:function(t){this._attr("_h",t)},get:function(){return this._h},configurable:!0,enumerable:!0},_h:{enumerable:!1},z:{set:function(t){this._attr("_z",t)},get:function(){return this._z},configurable:!0,enumerable:!0},_z:{enumerable:!1},rotation:{set:function(t){this._attr("_rotation",t)},get:function(){return this._rotation},configurable:!0,enumerable:!0},_rotation:{enumerable:!1},alpha:{set:function(t){this._attr("_alpha",t)},get:function(){return this._alpha},configurable:!0,enumerable:!0},_alpha:{enumerable:!1},visible:{set:function(t){this._attr("_visible",t)},get:function(){return this._visible},configurable:!0,enumerable:!0},_visible:{enumerable:!1}},_define2DProperties:function(){for(var t in this._2D_property_definitions)Object.defineProperty(this,t,this._2D_property_definitions[t])},init:function(){this._globalZ=this[0],this._origin={x:0,y:0},this._bx1=0,this._bx2=0,this._by1=0,this._by2=0,this._children=[],this._define2DProperties(),this._entry=e.map.insert(this),this.bind("Move",function(t){var e=this._cbr||this._mbr||this;this._entry.update(e),this._children.length>0&&this._cascade(t)}),this.bind("Rotate",function(t){var e=this._cbr||this._mbr||this;this._entry.update(e),this._children.length>0&&this._cascade(t)}),this.bind("Remove",function(){if(this._children){for(var t=0;t<this._children.length;t++)delete this._children[t]._parent,this._children[t].destroy&&this._children[t].destroy();this._children=[]}this._parent&&this._parent.detach(this),e.map.remove(this),this.detach()})},offsetBoundary:function(t,e,i,n){return 1===arguments.length&&(e=i=n=t),this._bx1=t,this._bx2=i,this._by1=e,this._by2=n,this.trigger("BoundaryOffset"),this._calculateMBR(),this},_calculateMBR:function(){var t=this._origin.x+this._x,e=this._origin.y+this._y,i=-this._rotation*s,n=this._x-this._bx1-t,r=this._x+this._w+this._bx2-t,o=this._y-this._by1-e,a=this._y+this._h+this._by2-e,h=Math.cos(i),c=Math.sin(i);h=1e-10>h&&h>-1e-10?0:h,c=1e-10>c&&c>-1e-10?0:c;var u=n*h+o*c,l=-n*c+o*h,d=r*h+o*c,_=-r*c+o*h,f=r*h+a*c,p=-r*c+a*h,g=n*h+a*c,m=-n*c+a*h,v=Math.floor(Math.min(u,d,f,g)+t),y=Math.floor(Math.min(l,_,p,m)+e),x=Math.ceil(Math.max(u,d,f,g)+t),w=Math.ceil(Math.max(l,_,p,m)+e);if(this._mbr?(this._mbr._x=v,this._mbr._y=y,this._mbr._w=x-v,this._mbr._h=w-y):this._mbr={_x:v,_y:y,_w:x-v,_h:w-y},this._cbr){var b=this._cbr,D=b.cx,C=b.cy,M=b.r,T=t+(D+this._x-t)*h+(C+this._y-e)*c,R=e-(D+this._x-t)*c+(C+this._y-e)*h;b._x=Math.min(T-M,v),b._y=Math.min(R-M,y),b._w=Math.max(T+M,x)-b._x,b._h=Math.max(R+M,w)-b._y}},_rotate:function(t){var e=-1*(t%360),i=this._rotation-t;if(0!==i){this._rotation=t;var n=e*s,r={x:this._origin.x+this._x,y:this._origin.y+this._y};this._calculateMBR();{var o=i*s;Math.cos(n),Math.sin(n)}this.trigger("Rotate",{cos:Math.cos(o),sin:Math.sin(o),deg:i,rad:o,o:r})}},area:function(){return this._w*this._h},intersect:function(t,e,i,n){var r,s=this._mbr||this;return r="object"==typeof t?t:{_x:t,_y:e,_w:i,_h:n},s._x<r._x+r._w&&s._x+s._w>r._x&&s._y<r._y+r._h&&s._y+s._h>r._y},within:function(t,e,i,n){var r,s=this._mbr||this;return r="object"==typeof t?t:{_x:t,_y:e,_w:i,_h:n},r._x<=s._x&&r._x+r._w>=s._x+s._w&&r._y<=s._y&&r._y+r._h>=s._y+s._h},contains:function(t,e,i,n){var r,s=this._mbr||this;return r="object"==typeof t?t:{_x:t,_y:e,_w:i,_h:n},r._x>=s._x&&r._x+r._w<=s._x+s._w&&r._y>=s._y&&r._y+r._h<=s._y+s._h},pos:function(t){return t=t||{},t._x=this._x,t._y=this._y,t._w=this._w,t._h=this._h,t},mbr:function(t){return t=t||{},this._mbr?(t._x=this._mbr._x,t._y=this._mbr._y,t._w=this._mbr._w,t._h=this._mbr._h,t):this.pos(t)},isAt:function(t,e){if(this.mapArea)return this.mapArea.containsPoint(t,e);if(this.map)return this.map.containsPoint(t,e);var i=this._mbr||this;return i._x<=t&&i._x+i._w>=t&&i._y<=e&&i._y+i._h>=e},move:function(t,e){return"n"===t.charAt(0)&&(this.y-=e),"s"===t.charAt(0)&&(this.y+=e),("e"===t||"e"===t.charAt(1))&&(this.x+=e),("w"===t||"w"===t.charAt(1))&&(this.x-=e),this},shift:function(t,e,i,n){return t&&(this.x+=t),e&&(this.y+=e),i&&(this.w+=i),n&&(this.h+=n),this},_cascade:function(t){if(t){var e,i=0,n=this._children,r=n.length;if("cos"in t||"sin"in t)for(;r>i;++i)e=n[i],"rotate"in e&&e.rotate(t);else for(var s=this._x-t._x,o=this._y-t._y,a=this._w-t._w,h=this._h-t._h;r>i;++i)e=n[i],e.shift(s,o,a,h)}},attach:function(){for(var t,e=0,i=arguments,n=arguments.length;n>e;++e)t=i[e],t._parent&&t._parent.detach(t),t._parent=this,this._children.push(t);return this},detach:function(t){var e;if(!t){for(e=0;e<this._children.length;e++)this._children[e]._parent=null;return this._children=[],this}for(e=0;e<this._children.length;e++)this._children[e]==t&&this._children.splice(e,1);return t._parent=null,this},origin:function(t,e){if("string"==typeof t)if("centre"===t||"center"===t||-1===t.indexOf(" "))t=this._w/2,e=this._h/2;else{var i=t.split(" ");"top"===i[0]?e=0:"bottom"===i[0]?e=this._h:("middle"===i[0]||"center"===i[1]||"centre"===i[1])&&(e=this._h/2),"center"===i[1]||"centre"===i[1]||"middle"===i[1]?t=this._w/2:"left"===i[1]?t=0:"right"===i[1]&&(t=this._w)}return this._origin.x=t,this._origin.y=e,this},flip:function(t){return t=t||"X",this["_flip"+t]||(this["_flip"+t]=!0,this.trigger("Invalidate")),this},unflip:function(t){return t=t||"X",this["_flip"+t]&&(this["_flip"+t]=!1,this.trigger("Invalidate")),this},rotate:function(t){var e,i;e=(this._x+this._origin.x-t.o.x)*t.cos+(this._y+this._origin.y-t.o.y)*t.sin+(t.o.x-this._origin.x),i=(this._y+this._origin.y-t.o.y)*t.cos-(this._x+this._origin.x-t.o.x)*t.sin+(t.o.y-this._origin.y),this._attr("_rotation",this._rotation-t.deg),this._attr("_x",e),this._attr("_y",i)},_attr:function(t,i){if(this[t]!==i){var n,r=e.rectManager._pool.copy(this);if("_rotation"===t)this._rotate(i);else if("_z"===t)this._globalZ=parseInt(i+e.zeroFill(this[0],5),10),this.trigger("reorder");else if("_x"===t||"_y"===t)n=this._mbr,n&&(n[t]-=this[t]-i,this._cbr&&(this._cbr[t]-=this[t]-i)),this[t]=i,this.trigger("Move",r);else if("_h"===t||"_w"===t){n=this._mbr;var s=this[t];this[t]=i,n&&this._calculateMBR(),"_w"===t?this.trigger("Resize",{axis:"w",amount:i-s}):"_h"===t&&this.trigger("Resize",{axis:"h",amount:i-s}),this.trigger("Move",r)}this[t]=i,this.trigger("Invalidate"),e.rectManager._pool.recycle(r)}}}),e.c("Supportable",{_ground:null,_groundComp:null,canLand:!0,init:function(){this.requires("2D"),this.__area={_x:0,_y:0,_w:0,_h:0},this.defineField("ground",function(){return this._ground},function(){})},remove:function(){this.unbind("EnterFrame",this._detectGroundTick)},startGroundDetection:function(t){return t&&(this._groundComp=t),this.uniqueBind("EnterFrame",this._detectGroundTick),this},stopGroundDetection:function(){return this.unbind("EnterFrame",this._detectGroundTick),this},_detectGroundTick:function(){var t=this._groundComp,i=this._ground,n=e.rectManager.overlap,r=this._cbr||this._mbr||this,s=this.__area;if(s._x=r._x,s._y=r._y+1,s._w=r._w,s._h=r._h,i){var o=i._cbr||i._mbr||i;i.__c[t]&&n(o,s)||(this._ground=null,this.trigger("LiftedOffGround",i),i=null)}if(!i)for(var a,h,c=e.map.search(s,!1),u=0,l=c.length;l>u;++u)if(a=c[u],h=a._cbr||a._mbr||a,a!==this&&a.__c[t]&&n(h,s)&&(this.canLand=!0,this.trigger("CheckLanding",a),this.canLand)){this._ground=i=a,this.y=a._y-this._h,this.trigger("LandedOnGround",i);break}}}),e.c("GroundAttacher",{_groundAttach:function(t){t.attach(this)},_groundDetach:function(t){t.detach(this)},init:function(){this.requires("Supportable"),this.bind("LandedOnGround",this._groundAttach),this.bind("LiftedOffGround",this._groundDetach)},remove:function(){this.unbind("LandedOnGround",this._groundAttach),this.unbind("LiftedOffGround",this._groundDetach)}}),e.c("Gravity",{_gravityConst:.2,init:function(){this.requires("2D, Supportable, Motion"),this.bind("LiftedOffGround",this._startGravity),this.bind("LandedOnGround",this._stopGravity)},remove:function(){this.unbind("LiftedOffGround",this._startGravity),this.unbind("LandedOnGround",this._stopGravity)},_gravityCheckLanding:function(){this._dy<0&&(this.canLand=!1)},gravity:function(t){return this.bind("CheckLanding",this._gravityCheckLanding),this.startGroundDetection(t),this._startGravity(),this},antigravity:function(){return this._stopGravity(),this.stopGroundDetection(),this.unbind("CheckLanding",this._gravityCheckLanding),this},gravityConst:function(t){return this._gravityActive&&(this.ay-=this._gravityConst,this.ay+=t),this._gravityConst=t,this},_startGravity:function(){this._gravityActive=!0,this.ay+=this._gravityConst},_stopGravity:function(){this.ay=0,this.vy=0,this._gravityActive=!1}});var o=function(t,i,n,r){var s=i+n,o="_"+s,a={key:"",oldValue:0};r?e.defineField(t,s,function(){return this[o]},function(t){var e=this[o];t!==e&&(this[o]=t,a.key=s,a.oldValue=e,this.trigger("MotionChange",a))}):e.defineField(t,s,function(){return this[o]},function(){}),Object.defineProperty(t,o,{value:0,writable:!0,enumerable:!1,configurable:!1})},a=function(t,i,n,r){var s=i+"x",o=i+"y",a="_"+s,h="_"+o;return n?(e.defineField(r,"x",function(){return t[a]},function(e){t[s]=e}),e.defineField(r,"y",function(){return t[h]},function(e){t[o]=e})):(e.defineField(r,"x",function(){return t[a]},function(){}),e.defineField(r,"y",function(){return t[h]},function(){})),Object.seal&&Object.seal(r),r};e.c("AngularMotion",{_vrotation:0,_arotation:0,_drotation:0,init:function(){this.requires("2D"),o(this,"v","rotation",!0),o(this,"a","rotation",!0),o(this,"d","rotation",!1),this.__oldRevolution=0,this.bind("EnterFrame",this._angularMotionTick),this.bind("FPSChange",this._angularChangeFPS),this._angularChangeFPS(e.timer.FPS())},remove:function(){this.unbind("EnterFrame",this._angularMotionTick),this.unbind("FPSChange",this._angularChangeFPS)},_angularChangeFPS:function(t){this._dtFactor=t/1e3},resetAngularMotion:function(){return this._drotation=0,this.vrotation=0,this.arotation=0,this},_angularMotionTick:function(t){var e=t.dt*this._dtFactor,i=this._vrotation,n=i>>31|-i>>>31;this.__oldRevolution!==n&&(this.__oldRevolution=n,this.trigger("NewRevolution",n));var r=this._rotation,s=this._vrotation,o=this._arotation,a=r+s*e+.5*o*e*e;this.vrotation=s+o*e,this._drotation=a-r,0!==this._drotation&&(this.rotation=a,this.trigger("Rotated",r))}}),e.c("Motion",{_vx:0,_vy:0,_ax:0,_ay:0,_dx:0,_dy:0,init:function(){this.requires("2D"),o(this,"v","x",!0),o(this,"v","y",!0),this._velocity=a(this,"v",!0,new e.math.Vector2D),o(this,"a","x",!0),o(this,"a","y",!0),this._acceleration=a(this,"a",!0,new e.math.Vector2D),o(this,"d","x",!1),o(this,"d","y",!1),this._motionDelta=a(this,"d",!1,new e.math.Vector2D),this.__movedEvent={axis:"",oldValue:0},this.__directionEvent={x:0,y:0},this.__oldDirection={x:0,y:0},this.bind("EnterFrame",this._linearMotionTick),this.bind("FPSChange",this._linearChangeFPS),this._linearChangeFPS(e.timer.FPS())},remove:function(){this.unbind("EnterFrame",this._linearMotionTick),this.unbind("FPSChange",this._linearChangeFPS)},_linearChangeFPS:function(t){this._dtFactor=t/1e3},resetMotion:function(){return this.vx=0,this.vy=0,this.ax=0,this.ay=0,this._dx=0,this._dy=0,this},motionDelta:function(){return this._motionDelta},velocity:function(){return this._velocity},acceleration:function(){return this._acceleration},_linearMotionTick:function(t){var e=t.dt*this._dtFactor,i=this.__oldDirection,n=this._vx,r=n>>31|-n>>>31,s=this._vy,o=s>>31|-s>>>31;if(i.x!==r||i.y!==o){var a=this.__directionEvent;a.x=i.x=r,a.y=i.y=o,this.trigger("NewDirection",a)}var h=this._x,c=this._vx,u=this._ax,l=this._y,d=this._vy,_=this._ay,f=h+c*e+.5*u*e*e,p=l+d*e+.5*_*e*e;this.vx=c+u*e,this.vy=d+_*e,this._dx=f-h,this._dy=p-l;var g=this.__movedEvent;0!==this._dx&&(this.x=f,g.axis="x",g.oldValue=h,this.trigger("Moved",g)),0!==this._dy&&(this.y=p,g.axis="y",g.oldValue=l,this.trigger("Moved",g))}}),e.polygon=function(t){arguments.length>1&&(t=Array.prototype.slice.call(arguments,0)),this.points=t},e.polygon.prototype={containsPoint:function(t,e){var i,n,r=this.points,s=r.length/2,o=!1;for(i=0,n=s-1;s>i;n=i++)r[2*i+1]>e!=r[2*n+1]>e&&t<(r[2*n]-r[2*i])*(e-r[2*i+1])/(r[2*n+1]-r[2*i+1])+r[2*i]&&(o=!o);return o},shift:function(t,e){for(var i=0,n=this.points,r=n.length;r>i;i+=2)n[i]+=t,n[i+1]+=e},clone:function(){return new e.polygon(this.points.slice(0))},rotate:function(t){for(var e,i,n=0,r=this.points,s=r.length;s>n;n+=2)e=t.o.x+(r[n]-t.o.x)*t.cos+(r[n+1]-t.o.y)*t.sin,i=t.o.y-(r[n]-t.o.x)*t.sin+(r[n+1]-t.o.y)*t.cos,r[n]=e,r[n+1]=i}},e.circle=function(t,e,i){this.x=t,this.y=e,this.radius=i,this.points=[];for(var n,r=0;16>r;r+=2)n=r*Math.PI/8,this.points[r]=this.x+Math.sin(n)*i,this.points[r+1]=this.y+Math.cos(n)*i},e.circle.prototype={containsPoint:function(t,e){var i=this.radius,n=(Math.sqrt,this.x-t),r=this.y-e;return i*i>n*n+r*r},shift:function(t,e){this.x+=t,this.y+=e;for(var i=0,n=this.points,r=n.length;r>i;i+=2)n[i]+=t,n[i+1]+=e},rotate:function(){}},e.matrix=function(t){this.mtx=t,this.width=t[0].length,this.height=t.length},e.matrix.prototype={x:function(t){if(this.width==t.height){for(var i=[],n=0;n<this.height;n++){i[n]=[];for(var r=0;r<t.width;r++){for(var s=0,o=0;o<this.width;o++)s+=this.mtx[n][o]*t.mtx[o][r];i[n][r]=s}}return new e.matrix(i)}},e:function(t,e){return 1>t||t>this.mtx.length||1>e||e>this.mtx[0].length?null:this.mtx[t-1][e-1]}}},{"../core/core.js":7,"./spatial-grid.js":41}],38:[function(t){var e=t("../core/core.js"),i=Math.PI/180;e.c("Collision",{init:function(){this.requires("2D"),this._collisionData={},this.collision()},remove:function(){this._cbr=null,this.unbind("Resize",this._resizeMap),this.unbind("Resize",this._checkBounds)},collision:function(t){if(this.unbind("Resize",this._resizeMap),this.unbind("Resize",this._checkBounds),t){if(arguments.length>1){var n=Array.prototype.slice.call(arguments,0);t=new e.polygon(n)}else t=t.clone();this._findBounds(t.points)}else t=new e.polygon([0,0,this._w,0,this._w,this._h,0,this._h]),this.bind("Resize",this._resizeMap),this._cbr=null;return this.rotation&&t.rotate({cos:Math.cos(-this.rotation*i),sin:Math.sin(-this.rotation*i),o:{x:this._origin.x,y:this._origin.y}}),this.map=t,this.attach(this.map),this.map.shift(this._x,this._y),this.trigger("NewHitbox",t),this},_findBounds:function(t){for(var e=1/0,i=-1/0,n=1/0,r=-1/0,s=t.length,o=0;s>o;o+=2)t[o]<e&&(e=t[o]),t[o]>i&&(i=t[o]),t[o+1]<n&&(n=t[o+1]),t[o+1]>r&&(r=t[o+1]);var a={cx:(e+i)/2,cy:(n+r)/2,r:Math.sqrt((i-e)*(i-e)+(r-n)*(r-n))/2};return e>=0&&n>=0&&(this._checkBounds=function(){null===this._cbr&&this._w<i||this._h<r?(this._cbr=a,this._calculateMBR()):this._cbr&&(this._cbr=null,this._calculateMBR())},this.bind("Resize",this._checkBounds)),e>=0&&n>=0&&i<=this._w&&r<=this._h?(this._cbr=null,!1):(this._cbr=a,this._calculateMBR(),!0)},_resizeMap:function(t){var e,n,r=this.rotation*i,s=this.map.points;"w"===t.axis?(r?(e=t.amount*Math.cos(r),n=t.amount*Math.sin(r)):(e=t.amount,n=0),s[2]+=e,s[3]+=n):(r?(n=t.amount*Math.cos(r),e=-t.amount*Math.sin(r)):(e=0,n=t.amount),s[6]+=e,s[7]+=n),s[4]+=e,s[5]+=n},hit:function(t){var i,n,r,s,o=this._cbr||this._mbr||this,a=e.map.search(o,!1),h=0,c=a.length,u={},l=e.rectManager.overlap,d="map"in this&&"containsPoint"in this.map,_=[];if(!c)return!1;for(;c>h;++h)n=a[h],r=n._cbr||n._mbr||n,n&&(i=n[0],!u[i]&&this[0]!==i&&n.__c[t]&&l(r,o)&&(u[i]=n));for(s in u)if(n=u[s],d&&"map"in n){var f=this._SAT(this.map,n.map);f.obj=n,f.type="SAT",f&&_.push(f)}else _.push({obj:n,type:"MBR"});return _.length?_:!1},onHit:function(t,e,i){var n=!1;return this.bind("EnterFrame",function(){var r=this.hit(t);r?(n=!0,e.call(this,r)):n&&("function"==typeof i&&i.call(this),n=!1)}),this},_createCollisionHandler:function(t,e){return function(){var i=this.hit(t);if(e.occurring===!0){if(i!==!1)return;e.occurring=!1,this.trigger("HitOff",t)}else i!==!1&&(e.occurring=!0,this.trigger("HitOn",i))}},checkHits:function(){var t=arguments,e=0;for(1===t.length&&(t=t[0].split(/\s*,\s*/));e<t.length;++e){var i=t[e],n=this._collisionData[i];void 0===n&&(this._collisionData[i]=n={occurring:!1,handler:null},n.handler=this._createCollisionHandler(i,n),this.bind("EnterFrame",n.handler))}return this},ignoreHits:function(){var t,e=arguments,i=0;if(0===e.length){for(t in this._collisionData)this.unbind("EnterFrame",t.handler);this._collisionData={}}for(1===e.length&&(e=e[0].split(/\s*,\s*/));i<e.length;++i){var n=e[i];t=this._collisionData[n],void 0!==t&&(this.unbind("EnterFrame",t.handler),delete this._collisionData[n])}return this},resetHitChecks:function(){var t,e=arguments,i=0;if(0===e.length)for(t in this._collisionData)this._collisionData[t].occurring=!1;for(1===e.length&&(e=e[0].split(/\s*,\s*/));i<e.length;++i){var n=e[i];t=this._collisionData[n],void 0!==t&&(t.occurring=!1)}return this},_SAT:function(t,e){var i,n,r,s,o,a,h,c,u,l=0,d=t.points,_=e.points,f=d.length/2,p=_.length/2,g=0,m=0,v=-1/0,y=null,x=null;for(l=0;f>l;l++){for(u=l==f-1?0:l+1,g=-(d[2*l+1]-d[2*u+1]),m=d[2*l]-d[2*u],n=Math.sqrt(g*g+m*m),g/=n,m/=n,r=s=1/0,o=a=-1/0,i=0;f>i;++i)c=d[2*i]*g+d[2*i+1]*m,c>o&&(o=c),r>c&&(r=c);for(i=0;p>i;++i)c=_[2*i]*g+_[2*i+1]*m,c>a&&(a=c),s>c&&(s=c);if(s>r?(h=s-o,g=-g,m=-m):h=r-a,h>=0)return!1;h>v&&(v=h,y=g,x=m)}for(l=0;p>l;l++){for(u=l==p-1?0:l+1,g=-(_[2*l+1]-_[2*u+1]),m=_[2*l]-_[2*u],n=Math.sqrt(g*g+m*m),g/=n,m/=n,r=s=1/0,o=a=-1/0,i=0;f>i;++i)c=d[2*i]*g+d[2*i+1]*m,c>o&&(o=c),r>c&&(r=c);for(i=0;p>i;++i)c=_[2*i]*g+_[2*i+1]*m,c>a&&(a=c),s>c&&(s=c);if(s>r?(h=s-o,g=-g,m=-m):h=r-a,h>=0)return!1;h>v&&(v=h,y=g,x=m)}return{overlap:v,normal:{x:y,y:x}}}})},{"../core/core.js":7}],39:[function(t){var e=t("../core/core.js");e.math={abs:function(t){return 0>t?-t:t},amountOf:function(t,e,i){return i>e?(t-e)/(i-e):(t-i)/(e-i)},clamp:function(t,e,i){return t>i?i:e>t?e:t},degToRad:function(t){return t*Math.PI/180},distance:function(t,i,n,r){var s=e.math.squaredDistance(t,i,n,r);return Math.sqrt(parseFloat(s))},lerp:function(t,e,i){return t+(e-t)*i},negate:function(t){return Math.random()<t?-1:1},radToDeg:function(t){return 180*t/Math.PI},randomElementOfArray:function(t){return t[Math.floor(t.length*Math.random())]},randomInt:function(t,e){return t+Math.floor((1+e-t)*Math.random())},randomNumber:function(t,e){return t+(e-t)*Math.random()},squaredDistance:function(t,e,i,n){return(t-i)*(t-i)+(e-n)*(e-n)},withinRange:function(t,e,i){return t>=e&&i>=t}},e.math.Vector2D=function(){function t(e,i){if(e instanceof t)this.x=e.x,this.y=e.y;else if(2===arguments.length)this.x=e,this.y=i;else if(arguments.length>0)throw"Unexpected number of arguments for Vector2D()"}return t.prototype.x=0,t.prototype.y=0,t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.angleBetween=function(t){return Math.atan2(this.x*t.y-this.y*t.x,this.x*t.x+this.y*t.y)},t.prototype.angleTo=function(t){return Math.atan2(t.y-this.y,t.x-this.x)},t.prototype.clone=function(){return new t(this)},t.prototype.distance=function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))},t.prototype.distanceSq=function(t){return(t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)},t.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},t.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y},t.prototype.crossProduct=function(t){return this.x*t.y-this.y*t.x},t.prototype.equals=function(e){return e instanceof t&&this.x==e.x&&this.y==e.y},t.prototype.perpendicular=function(e){return e=e||new t,e.setValues(-this.y,this.x)},t.prototype.getNormal=function(e,i){return i=i||new t,i.setValues(e.y-this.y,this.x-e.x).normalize()},t.prototype.isZero=function(){return 0===this.x&&0===this.y},t.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.magnitudeSq=function(){return this.x*this.x+this.y*this.y},t.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return 0===t?(this.x=1,this.y=0):(this.x/=t,this.y/=t),this},t.prototype.scale=function(t,e){return void 0===e&&(e=t),this.x*=t,this.y*=e,this},t.prototype.scaleToMagnitude=function(t){var e=t/this.magnitude();return this.x*=e,this.y*=e,this},t.prototype.setValues=function(e,i){return e instanceof t?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i),this},t.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.toString=function(){return"Vector2D("+this.x+", "+this.y+")"},t.prototype.translate=function(t,e){return void 0===e&&(e=t),this.x+=t,this.y+=e,this},t.tripleProduct=function(t,i,n,r){r=r||new e.math.Vector2D;var s=t.dotProduct(n),o=i.dotProduct(n);return r.setValues(i.x*s-t.x*o,i.y*s-t.y*o)},t}(),e.math.Matrix2D=function(){return Matrix2D=function(t,e,i,n,r,s){if(t instanceof Matrix2D)this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f;else if(6===arguments.length)this.a=t,this.b=e,this.c=i,this.d=n,this.e=r,this.f=s;else if(arguments.length>0)throw"Unexpected number of arguments for Matrix2D()"},Matrix2D.prototype.a=1,Matrix2D.prototype.b=0,Matrix2D.prototype.c=0,Matrix2D.prototype.d=1,Matrix2D.prototype.e=0,Matrix2D.prototype.f=0,Matrix2D.prototype.apply=function(t){var e=t.x;return t.x=e*this.a+t.y*this.c+this.e,t.y=e*this.b+t.y*this.d+this.f,t},Matrix2D.prototype.clone=function(){return new Matrix2D(this)},Matrix2D.prototype.combine=function(t){var e=this.a;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,e=this.c,this.c=e*t.a+this.d*t.c,this.d=e*t.b+this.d*t.d,e=this.e,this.e=e*t.a+this.f*t.c+t.e,this.f=e*t.b+this.f*t.d+t.f,this},Matrix2D.prototype.equals=function(t){return t instanceof Matrix2D&&this.a==t.a&&this.b==t.b&&this.c==t.c&&this.d==t.d&&this.e==t.e&&this.f==t.f},Matrix2D.prototype.determinant=function(){return this.a*this.d-this.b*this.c},Matrix2D.prototype.invert=function(){var t=this.determinant();if(0!==t){var e={a:this.a,b:this.b,c:this.c,d:this.d,e:this.e,f:this.f};this.a=e.d/t,this.b=-e.b/t,this.c=-e.c/t,this.d=e.a/t,this.e=(e.c*e.f-e.e*e.d)/t,this.f=(e.e*e.b-e.a*e.f)/t}return this},Matrix2D.prototype.isIdentity=function(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f},Matrix2D.prototype.isInvertible=function(){return 0!==this.determinant()},Matrix2D.prototype.preRotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a;return this.a=e*n-i*this.b,this.b=i*n+e*this.b,n=this.c,this.c=e*n-i*this.d,this.d=i*n+e*this.d,this},Matrix2D.prototype.preScale=function(t,e){return void 0===e&&(e=t),this.a*=t,this.b*=e,this.c*=t,this.d*=e,this},Matrix2D.prototype.preTranslate=function(t,e){return"number"==typeof t?(this.e+=t,this.f+=e):(this.e+=t.x,this.f+=t.y),this},Matrix2D.prototype.rotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a;return this.a=e*n-i*this.b,this.b=i*n+e*this.b,n=this.c,this.c=e*n-i*this.d,this.d=i*n+e*this.d,n=this.e,this.e=e*n-i*this.f,this.f=i*n+e*this.f,this},Matrix2D.prototype.scale=function(t,e){return void 0===e&&(e=t),this.a*=t,this.b*=e,this.c*=t,this.d*=e,this.e*=t,this.f*=e,this},Matrix2D.prototype.setValues=function(t,e,i,n,r,s){return t instanceof Matrix2D?(this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f):(this.a=t,this.b=e,this.c=i,this.d=n,this.e=r,this.f=s),this},Matrix2D.prototype.toString=function(){return"Matrix2D(["+this.a+", "+this.c+", "+this.e+"] ["+this.b+", "+this.d+", "+this.f+"] [0, 0, 1])"},Matrix2D.prototype.translate=function(t,e){return"number"==typeof t?(this.e+=this.a*t+this.c*e,this.f+=this.b*t+this.d*e):(this.e+=this.a*t.x+this.c*t.y,this.f+=this.b*t.x+this.d*t.y),this},Matrix2D}()},{"../core/core.js":7}],40:[function(t){var e=t("../core/core.js");e.extend({rectManager:{merge:function(t,e,i){return"undefined"==typeof i&&(i={}),i._h=Math.max(t._y+t._h,e._y+e._h),i._w=Math.max(t._x+t._w,e._x+e._w),i._x=Math.min(t._x,e._x),i._y=Math.min(t._y,e._y),i._w-=i._x,i._h-=i._y,i},overlap:function(t,e){return t._x<e._x+e._w&&t._x+t._w>e._x&&t._y<e._y+e._h&&t._y+t._h>e._y},mergeSet:function(t){for(var e=0;e<t.length-1;)this.overlap(t[e],t[e+1])?(this.merge(t[e],t[e+1],t[e]),t.splice(e+1,1),e>0&&e--):e++;return t},boundingRect:function(t){if(t&&t.length){var e,i,n=1,r=t.length,s=t[0];for(s=[s._x,s._y,s._x+s._w,s._y+s._h];r>n;)e=t[n],i=[e._x,e._y,e._x+e._w,e._y+e._h],i[0]<s[0]&&(s[0]=i[0]),i[1]<s[1]&&(s[1]=i[1]),i[2]>s[2]&&(s[2]=i[2]),i[3]>s[3]&&(s[3]=i[3]),n++;return i=s,s={_x:i[0],_y:i[1],_w:i[2]-i[0],_h:i[3]-i[1]}}},_pool:function(){var t=[],e=0;return{get:function(i,n,r,s){t.length<=e&&t.push({});var o=t[e++];return o._x=i,o._y=n,o._w=r,o._h=s,o},copy:function(i){t.length<=e&&t.push({});var n=t[e++];return n._x=i._x,n._y=i._y,n._w=i._w,n._h=i._h,n},recycle:function(){e--}}}()}})},{"../core/core.js":7}],41:[function(t,e){function i(t,e,i){this.keys=t,this.map=i,this.obj=e}var n,r=(t("../core/core.js"),function(t){n=t||64,this.map={}}),s=" ",o={};r.prototype={insert:function(t){var e,n,s=r.key(t),o=new i(s,t,this),a=0;for(a=s.x1;a<=s.x2;a++)for(e=s.y1;e<=s.y2;e++)n=a<<16^e,this.map[n]||(this.map[n]=[]),this.map[n].push(t);return o},search:function(t,e){var i,n,s,a,h,c=r.key(t,o),u=[];for(void 0===e&&(e=!0),i=c.x1;i<=c.x2;i++)for(n=c.y1;n<=c.y2;n++)if(h=this.map[i<<16^n])for(s=0;s<h.length;s++)u.push(h[s]);if(e){var l,d,_=[],f={};for(i=0,a=u.length;a>i;i++)l=u[i],l&&(d=l[0],l=l._mbr||l,!f[d]&&l._x<t._x+t._w&&l._x+l._w>t._x&&l._y<t._y+t._h&&l._y+l._h>t._y&&(f[d]=u[i]));for(l in f)_.push(f[l]);return _}return u},remove:function(t,e){var i,n,s=0;for(1==arguments.length&&(e=t,t=r.key(e,o)),s=t.x1;s<=t.x2;s++)for(i=t.y1;i<=t.y2;i++)if(n=s<<16^i,this.map[n]){var a,h=this.map[n],c=h.length;for(a=0;c>a;a++)h[a]&&h[a][0]===e[0]&&h.splice(a,1)}},refresh:function(t){var e,i,n,s,o,a=t.keys,h=t.obj;for(i=a.x1;i<=a.x2;i++)for(n=a.y1;n<=a.y2;n++)if(e=this.map[i<<16^n])for(o=e.length,s=0;o>s;s++)e[s]&&e[s][0]===h[0]&&e.splice(s,1);for(r.key(h,a),i=a.x1;i<=a.x2;i++)for(n=a.y1;n<=a.y2;n++)e=this.map[i<<16^n],e||(e=this.map[i<<16^n]=[]),e.push(h);return t},boundaries:function(){var t,e,i={max:{x:-1/0,y:-1/0},min:{x:1/0,y:1/0}},n={max:{x:-1/0,y:-1/0},min:{x:1/0,y:1/0}};for(var r in this.map)if(this.map[r].length){var s=r>>16,o=r<<16>>16;if(0>o&&(s=-1^s),s>=i.max.x){i.max.x=s;for(t in this.map[r])e=this.map[r][t],"object"==typeof e&&"requires"in e&&(n.max.x=Math.max(n.max.x,e.x+e.w))}if(s<=i.min.x){i.min.x=s;for(t in this.map[r])e=this.map[r][t],"object"==typeof e&&"requires"in e&&(n.min.x=Math.min(n.min.x,e.x))}if(o>=i.max.y){i.max.y=o;for(t in this.map[r])e=this.map[r][t],"object"==typeof e&&"requires"in e&&(n.max.y=Math.max(n.max.y,e.y+e.h))}if(o<=i.min.y){i.min.y=o;for(t in this.map[r])e=this.map[r][t],"object"==typeof e&&"requires"in e&&(n.min.y=Math.min(n.min.y,e.y))}}return n}},r.key=function(t,e){return t._mbr&&(t=t._mbr),e||(e={}),e.x1=Math.floor(t._x/n),e.y1=Math.floor(t._y/n),e.x2=Math.floor((t._w+t._x)/n),e.y2=Math.floor((t._h+t._y)/n),e},r.hash=function(t){return t.x1+s+t.y1+s+t.x2+s+t.y2},i.prototype={update:function(t){r.hash(r.key(t,o))!=r.hash(this.keys)&&this.map.refresh(this)}},e.exports=r},{"../core/core.js":7}]},{},[16]);
